{"title":"基于seq2seq+attention实现文本摘要","slug":"基于seq2seq+attention实现文本摘要","date":"2021-01-04T14:19:00.000Z","updated":"2022-09-30T06:56:37.191Z","comments":true,"path":"api/articles/基于seq2seq+attention实现文本摘要.json","excerpt":null,"covers":["/.top//attachment:5f1f621e-0619-402f-b2b9-1827c3fb500b.png","/.top//attachment:7e378fd8-a713-4afa-9f79-a3059af5cd72.png","/.top//attachment:7a9c3e26-c015-4bf8-b2dd-96f082617b03.png","/.top//attachment:83f35c9b-6e96-448a-8b04-e70de555a8e4.png","/.top//attachment:08055b25-8707-449b-8782-1cf18c9eaf3b.png","/.top//attachment:6a34d1b0-6c17-4fe1-9d24-e521610d0f76.png","/.top//attachment:e4ae16be-a267-4f86-9401-d4284cb6223d.png","/.top//attachment:a96e27f2-6e52-47cf-bc06-9b18468f2e27.png","https://oceaneyes.top/img/zhishigroup.jpg","https://oceaneyes.top/img/alipay.jpg","https://oceaneyes.top/img/wechatpay.jpg"],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"/assets/css/APlayer.min.css\"><script src=\"/assets/js/APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><h2 id=\"基于seq2seqattention实现文本摘要\">基于seq2seq+attention实现文本摘要</h2>\n<ul>\n<li><strong>任务描述</strong>:\n自动摘要是指给出一段文本，我们从中提取出要点，然后再形成一个短的概括性的文本</li>\n</ul>\n<figure>\n<img src=\"/.top//attachment:5f1f621e-0619-402f-b2b9-1827c3fb500b.png\" alt=\"image.png\">\n<figcaption aria-hidden=\"true\">image.png</figcaption>\n</figure>\n<p><img src=\"/.top//attachment:7e378fd8-a713-4afa-9f79-a3059af5cd72.png\" alt=\"image.png\">\nhttps://github.com/pytorch/text/releases/tag/v0.9.0-rc5</p>\n<div class=\"sourceCode\" id=\"cb1\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb1-1\"><a href=\"#cb1-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch</span>\n<span id=\"cb1-2\"><a href=\"#cb1-2\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch.nn <span class=\"im\">as</span> nn</span>\n<span id=\"cb1-3\"><a href=\"#cb1-3\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch.optim <span class=\"im\">as</span> optim</span>\n<span id=\"cb1-4\"><a href=\"#cb1-4\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch.nn.functional <span class=\"im\">as</span> F</span>\n<span id=\"cb1-5\"><a href=\"#cb1-5\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> spacy</span>\n<span id=\"cb1-6\"><a href=\"#cb1-6\" aria-hidden=\"true\" tabindex=\"-1\"></a> </span>\n<span id=\"cb1-7\"><a href=\"#cb1-7\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">from</span> torchtext.legacy.datasets <span class=\"im\">import</span> Multi30k</span>\n<span id=\"cb1-8\"><a href=\"#cb1-8\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">from</span> torchtext.legacy.data <span class=\"im\">import</span> Field,Iterator,BucketIterator,TabularDataset</span>\n<span id=\"cb1-9\"><a href=\"#cb1-9\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb1-10\"><a href=\"#cb1-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> pandas <span class=\"im\">as</span> pd</span>\n<span id=\"cb1-11\"><a href=\"#cb1-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> numpy <span class=\"im\">as</span> np</span>\n<span id=\"cb1-12\"><a href=\"#cb1-12\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb1-13\"><a href=\"#cb1-13\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> random</span>\n<span id=\"cb1-14\"><a href=\"#cb1-14\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> math</span>\n<span id=\"cb1-15\"><a href=\"#cb1-15\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> time</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb2\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb2-1\"><a href=\"#cb2-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 全局初始化配置参数。 固定随机种子， 使得每次运行的结果相同</span></span>\n<span id=\"cb2-2\"><a href=\"#cb2-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>SEED <span class=\"op\">=</span> <span class=\"dv\">22</span></span>\n<span id=\"cb2-3\"><a href=\"#cb2-3\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb2-4\"><a href=\"#cb2-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>random.seed(SEED)</span>\n<span id=\"cb2-5\"><a href=\"#cb2-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>np.random.seed(SEED)</span>\n<span id=\"cb2-6\"><a href=\"#cb2-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>torch.manual_seed(SEED)</span>\n<span id=\"cb2-7\"><a href=\"#cb2-7\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb2-8\"><a href=\"#cb2-8\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">if</span> torch.cuda.is_available():</span>\n<span id=\"cb2-9\"><a href=\"#cb2-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>    torch.cuda.manual_seed_all(SEED)</span>\n<span id=\"cb2-10\"><a href=\"#cb2-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    torch.backends.cudnn.deterministic <span class=\"op\">=</span> <span class=\"va\">True</span></span></code></pre></div>\n<h2 id=\"数据准备\">数据准备</h2>\n<ul>\n<li>数据整理</li>\n<li>数据说明</li>\n<li>数据预处理</li>\n</ul>\n<h3 id=\"数据整理\">数据整理</h3>\n<div class=\"sourceCode\" id=\"cb3\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb3-1\"><a href=\"#cb3-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_train_path <span class=\"op\">=</span> <span class=\"st\">&quot;./dataset/train.csv&quot;</span></span>\n<span id=\"cb3-2\"><a href=\"#cb3-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_test_path <span class=\"op\">=</span> <span class=\"st\">&quot;./dataset/test.csv&quot;</span></span>\n<span id=\"cb3-3\"><a href=\"#cb3-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_val_path <span class=\"op\">=</span> <span class=\"st\">&quot;./dataset/val.csv&quot;</span></span></code></pre></div>\n<h3 id=\"数据说明\">数据说明</h3>\n<div class=\"sourceCode\" id=\"cb4\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb4-1\"><a href=\"#cb4-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_train <span class=\"op\">=</span> pd.read_csv(data_train_path,encoding<span class=\"op\">=</span><span class=\"st\">&quot;utf-8&quot;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb5\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb5-1\"><a href=\"#cb5-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_train.head()</span></code></pre></div>\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n    \n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n<thead>\n<tr style=\"text-align: right;\">\n<th>\n</th>\n<th>\ndocument\n</th>\n<th>\nsummary\n</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<th>\n0\n</th>\n<td>\njason blake of the islanders will miss the res...\n</td>\n<td>\nblake missing rest of season\n</td>\n</tr>\n<tr>\n<th>\n1\n</th>\n<td>\nthe u.s. military on wednesday captured a wife...\n</td>\n<td>\nu.s. arrests wife and daughter of saddam deput...\n</td>\n</tr>\n<tr>\n<th>\n2\n</th>\n<td>\ncraig bellamy 's future at west ham appeared i...\n</td>\n<td>\nwest ham drops bellamy amid transfer turmoil\n</td>\n</tr>\n<tr>\n<th>\n3\n</th>\n<td>\ncambridge - when barack obama sought advice be...\n</td>\n<td>\nin search for expertise harvard looms large\n</td>\n</tr>\n<tr>\n<th>\n4\n</th>\n<td>\nwall street held on to steep gains on monday ,...\n</td>\n<td>\nwall street ends a three-day losing streak\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"数据预处理\">数据预处理</h3>\n<ul>\n<li>构建分词函数</li>\n<li>构建预处理格式</li>\n<li>载入数据</li>\n<li>构建数据迭代器</li>\n<li>构建词表</li>\n</ul>\n<h4 id=\"构建分词函数\">构建分词函数</h4>\n<div class=\"sourceCode\" id=\"cb6\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb6-1\"><a href=\"#cb6-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 加载spacy的英文处理包</span></span>\n<span id=\"cb6-2\"><a href=\"#cb6-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>spacy_en <span class=\"op\">=</span> spacy.load(<span class=\"st\">&#39;en_core_web_sm&#39;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb7\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb7-1\"><a href=\"#cb7-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 构建分词函数， 返回文本里包含的所有词组的列表</span></span>\n<span id=\"cb7-2\"><a href=\"#cb7-2\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> tokenize(text):</span>\n<span id=\"cb7-3\"><a href=\"#cb7-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> [tok.text <span class=\"cf\">for</span> tok <span class=\"kw\">in</span> spacy_en.tokenizer(text)]</span></code></pre></div>\n<h4 id=\"构建预处理格式\">构建预处理格式</h4>\n<h5 id=\"torchtext的field函数可以构建预处理格式\">torchtext的Field函数可以构建预处理格式</h5>\n<ul>\n<li>sequential：代表是否需要将数据序列化，大多数自然语言处理任务都是序列计算</li>\n<li>tokenize：需要传入分词函数，传入之前定义的tokenize函数</li>\n<li>lower：代表是否转换成小写，为了统一处理，把所有的字符转换成小写</li>\n<li>include_lengths：代表是否返回序列的长度，在gpu计算中，通常是对矩阵的运算，因此每个batch中，矩阵的长度为该batch中所有数据里最长的长度，其他长度不够的数据通常用pad字符补齐，这就会导致矩阵中有很多pad字符。为了后续的计算中把这些pad字符规避掉，我们需要返回每个数据的真实长度，这里的长度是指分词后每个文本中词组的数量</li>\n<li>init_token：传入起始符号，自然语言处理的任务中通常需要在文本的开头加入起始符号，作为句子的开始标记</li>\n<li>eos_token：传入结束符号，自然语言处理的任务中通常需要在文本的加入结束符号，作为句子的结束标记</li>\n<li>pad_token：传入pad符号，用来补全长度不够的文本，默认为\n&lt;pad&gt;</li>\n<li>unk_token：传入unk符号，默认为\n&lt;unk&gt;。自然语言处理任务中，往往有一些词组不在我们构建的词表中，这种现场叫做00V（Out\nOf Vocabulary），用一个unk字符来表示这些字符。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb8\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb8-1\"><a href=\"#cb8-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOCUMENT <span class=\"op\">=</span> Field(sequential<span class=\"op\">=</span><span class=\"va\">True</span>, </span>\n<span id=\"cb8-2\"><a href=\"#cb8-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>                tokenize<span class=\"op\">=</span>tokenize,</span>\n<span id=\"cb8-3\"><a href=\"#cb8-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>                lower<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb8-4\"><a href=\"#cb8-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>                include_lengths<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb8-5\"><a href=\"#cb8-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>               init_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;sos&gt;&#39;</span>,</span>\n<span id=\"cb8-6\"><a href=\"#cb8-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>               eos_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;eos&gt;&#39;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb9\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb9-1\"><a href=\"#cb9-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>SUMMARY <span class=\"op\">=</span> Field(sequential<span class=\"op\">=</span><span class=\"va\">True</span>, </span>\n<span id=\"cb9-2\"><a href=\"#cb9-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>                tokenize<span class=\"op\">=</span>tokenize,</span>\n<span id=\"cb9-3\"><a href=\"#cb9-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>                lower<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb9-4\"><a href=\"#cb9-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>                include_lengths<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb9-5\"><a href=\"#cb9-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>               init_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;sos&gt;&#39;</span>,</span>\n<span id=\"cb9-6\"><a href=\"#cb9-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>               eos_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;eos&gt;&#39;</span>)</span></code></pre></div>\n<h4 id=\"载入数据\">载入数据</h4>\n<div class=\"sourceCode\" id=\"cb10\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb10-1\"><a href=\"#cb10-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>fields <span class=\"op\">=</span> [(<span class=\"st\">&quot;document&quot;</span>,DOCUMENT),(<span class=\"st\">&quot;summary&quot;</span>,SUMMARY)]</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb11\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb11-1\"><a href=\"#cb11-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>train <span class=\"op\">=</span> TabularDataset(path<span class=\"op\">=</span>data_train_path, <span class=\"bu\">format</span><span class=\"op\">=</span><span class=\"st\">&quot;csv&quot;</span>, fields<span class=\"op\">=</span>fields, skip_header<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb11-2\"><a href=\"#cb11-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>val <span class=\"op\">=</span> TabularDataset(path<span class=\"op\">=</span>data_val_path, <span class=\"bu\">format</span><span class=\"op\">=</span><span class=\"st\">&quot;csv&quot;</span>, fields<span class=\"op\">=</span>fields, skip_header<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb11-3\"><a href=\"#cb11-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>test <span class=\"op\">=</span> TabularDataset(path<span class=\"op\">=</span>data_test_path, <span class=\"bu\">format</span><span class=\"op\">=</span><span class=\"st\">&quot;csv&quot;</span>, fields<span class=\"op\">=</span>fields, skip_header<span class=\"op\">=</span><span class=\"va\">True</span>)</span></code></pre></div>\n<h4 id=\"构建数据迭代器\">构建数据迭代器</h4>\n<h5 id=\"bucketiterator会自动将长度类似的文本归在一个batch这样可以减少补全字符pad的数量易于计算\">BucketIterator会自动将长度类似的文本归在一个batch，这样可以减少补全字符pad的数量，易于计算</h5>\n<ul>\n<li>train：传入之前用TabularDataset载入的数据</li>\n<li>batch_size：传入每个批次包含的数据数量</li>\n<li>device：代表传入数据的设备，可以选择gpu或者cpu</li>\n<li>sort_within_batch：代表是否对一个批次内的数据排序</li>\n<li>sort_key：排序方式，由于要使用到pack_padded_sequence用来规避pad符号，而pack_padded_sequence需要数据以降序的形式排列，所以这里用document的长度进行降序。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb12\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb12-1\"><a href=\"#cb12-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>device <span class=\"op\">=</span> torch.device(<span class=\"st\">&#39;cuda&#39;</span> <span class=\"cf\">if</span> torch.cuda.is_available() <span class=\"cf\">else</span> <span class=\"st\">&#39;cpu&#39;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb13\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb13-1\"><a href=\"#cb13-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>device</span></code></pre></div>\n<pre><code>device(type=&#39;cpu&#39;)</code></pre>\n<div class=\"sourceCode\" id=\"cb15\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb15-1\"><a href=\"#cb15-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>BATCH_SIZE <span class=\"op\">=</span> <span class=\"dv\">100</span> <span class=\"op\">//</span> <span class=\"dv\">20</span></span>\n<span id=\"cb15-2\"><a href=\"#cb15-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>train_iter <span class=\"op\">=</span> BucketIterator(train, batch_size<span class=\"op\">=</span>BATCH_SIZE, device<span class=\"op\">=</span>device, sort_key <span class=\"op\">=</span> <span class=\"kw\">lambda</span> x :<span class=\"bu\">len</span>(x.document), sort_within_batch<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb15-3\"><a href=\"#cb15-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>val_iter <span class=\"op\">=</span> BucketIterator(val,batch_size<span class=\"op\">=</span>BATCH_SIZE, device<span class=\"op\">=</span>device, sort_key <span class=\"op\">=</span> <span class=\"kw\">lambda</span> x:<span class=\"bu\">len</span>(x.document), sort_within_batch<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb15-4\"><a href=\"#cb15-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>test_iter <span class=\"op\">=</span> BucketIterator(test,batch_size<span class=\"op\">=</span>BATCH_SIZE, device<span class=\"op\">=</span>device, sort_key <span class=\"op\">=</span> <span class=\"kw\">lambda</span> x:<span class=\"bu\">len</span>(x.document), sort_within_batch<span class=\"op\">=</span><span class=\"va\">True</span>)</span></code></pre></div>\n<h4 id=\"构建词表\">构建词表</h4>\n<p>往往将字符转换成数字，需要构建词表，用以用数字表示每个词组，并用来训练embedding。\n- 在训练集上构建词表，频次低于min_freq的词组会被过滤。 -\n构建完词表后会自动将迭代器数据中的字符转换成单词在词表中的序号。</p>\n<p>在这里，我们对document和summary分别单独构建了词表，也可以只构建一个词表，使document和summary共享词表。</p>\n<div class=\"sourceCode\" id=\"cb16\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb16-1\"><a href=\"#cb16-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOCUMENT.build_vocab(train,min_freq<span class=\"op\">=</span> <span class=\"dv\">2</span>)</span>\n<span id=\"cb16-2\"><a href=\"#cb16-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>SUMMARY.build_vocab(train,min_freq<span class=\"op\">=</span><span class=\"dv\">2</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb17\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb17-1\"><a href=\"#cb17-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOCUMENT.vocab.itos[:<span class=\"dv\">100</span>]</span></code></pre></div>\n<pre><code>[&#39;&lt;unk&gt;&#39;,\n &#39;&lt;pad&gt;&#39;,\n &#39;&lt;sos&gt;&#39;,\n &#39;&lt;eos&gt;&#39;,\n &#39;the&#39;,\n &#39;#&#39;,\n &#39;.&#39;,\n &#39;,&#39;,\n &#39;a&#39;,\n &#39;of&#39;,\n &#39;to&#39;,\n &#39;in&#39;,\n &#39;and&#39;,\n &#39;on&#39;,\n &quot;&#39;s&quot;,\n &#39;-&#39;,\n &#39;for&#39;,\n &#39;said&#39;,\n &#39;that&#39;,\n &#39;with&#39;,\n &#39;at&#39;,\n &#39;an&#39;,\n &#39;`&#39;,\n &#39;as&#39;,\n &#39;by&#39;,\n &#39;from&#39;,\n &#39;has&#39;,\n &#39;his&#39;,\n &#39;tuesday&#39;,\n &#39;wednesday&#39;,\n &#39;thursday&#39;,\n &#39;its&#39;,\n &#39;monday&#39;,\n &#39;was&#39;,\n &#39;&lt;&#39;,\n &#39;&gt;&#39;,\n &#39;unk&#39;,\n &#39;is&#39;,\n &#39;friday&#39;,\n &#39;president&#39;,\n &#39;-lrb-&#39;,\n &#39;-rrb-&#39;,\n &#39;after&#39;,\n &#39;new&#39;,\n &#39;will&#39;,\n &#39;it&#39;,\n &#39;two&#39;,\n &#39;government&#39;,\n &#39;their&#39;,\n &#39;have&#39;,\n &#39;u.s&#39;,\n &#39;over&#39;,\n &quot;&#39;&#39;&quot;,\n &#39;minister&#39;,\n &#39;year&#39;,\n &#39;china&#39;,\n &#39;world&#39;,\n &#39;first&#39;,\n &#39;sunday&#39;,\n &#39;he&#39;,\n &#39;who&#39;,\n &#39;saturday&#39;,\n &#39;be&#39;,\n &#39;here&#39;,\n &#39;were&#39;,\n &#39;against&#39;,\n &#39;this&#39;,\n &#39;people&#39;,\n &#39;officials&#39;,\n &#39;up&#39;,\n &#39;are&#39;,\n &#39;more&#39;,\n &#39;country&#39;,\n &#39;us&#39;,\n &#39;united&#39;,\n &#39;police&#39;,\n &#39;percent&#39;,\n &#39;one&#39;,\n &#39;state&#39;,\n &#39;reported&#39;,\n &#39;into&#39;,\n &#39;million&#39;,\n &#39;last&#39;,\n &#39;three&#39;,\n &#39;official&#39;,\n &#39;been&#39;,\n &#39;than&#39;,\n &#39;had&#39;,\n &#39;not&#39;,\n &#39;would&#39;,\n &#39;but&#39;,\n &#39;years&#39;,\n &#39;about&#39;,\n &#39;former&#39;,\n &#39;prime&#39;,\n &#39;states&#39;,\n &#39;they&#39;,\n &#39;international&#39;,\n &#39;day&#39;,\n &#39;week&#39;]</code></pre>\n<h3 id=\"模型\">模型</h3>\n<ul>\n<li>模型概述</li>\n<li>模型结构定义</li>\n<li>模型实例化</li>\n<li>查看模型</li>\n</ul>\n<h4 id=\"模型该书\">模型该书</h4>\n<ul>\n<li><p>seq2seq是一个Encoder–Decoder结构的网络，它的输入是一个序列，输出也是一个序列，seq2seq最早应用在翻译模型中，输入原文，输出为翻译后的译文。</p></li>\n<li><p>attention机制的用途是建立生成的译文中的每个单词和原文每个单词的联系，通过这种依赖关系，生成更精准的译文，seq2seq的结构如下图所示：\n<img src=\"/.top//attachment:7a9c3e26-c015-4bf8-b2dd-96f082617b03.png\" alt=\"image.png\"></p>\n<ul>\n<li>左边为Encoder，是由rnn组成，顺序输入原文中单词的embedding，对于每个位置都输出一个hidden\nstate <span class=\"math inline\">\\(h_i\\)</span>\n作为这个状态的表示，这个状态包含了之前所有单词的信息，待序列中所有的单词计算完后，Encoder输出一个变量\n<span class=\"math inline\">\\(h\\)</span>\n作为整个序列的表示，这个变量可以直接是最后一个状态的表示，也可以对所有状态进行融合，将它们变换成一个固定维度的矩阵。</li>\n<li>右边是Decoder，它第一个状态的输入为Encoder的输出 <span class=\"math inline\">\\(h\\)</span> 和 [单词的embedding;\nattention]，方括号内表示两个变量的连接，输出为 <span class=\"math inline\">\\(s_j\\)</span> ，用[s_j; attention;\nembedding]预测这一步生成的单词，这里为了图像整体的简洁，没有画出attention对后面的状态的连接，实际上每一步生成都要连接attention。</li>\n<li>Decoder和Encoder之间有一个attention，在最早的seq2seq模型中是没有attention的，Decoder直接接收Encoder的输出\n<span class=\"math inline\">\\(h\\)</span>\n，这在生成译文单词的前期效果不错，但是随着生成单词的增多，rnn会逐渐遗忘掉\n<span class=\"math inline\">\\(h\\)</span>\n的信息，这会导致生成的单词不够精准，而且无法建立原文和译文每个单词对应的关系，而attention由于在生成的每一步都会引入到生产过程中，并且每一步都计算Decoder的状态和Encoder每个状态的相似度用来建立关系，不仅使得生成效果更好，而且具有更强的可解释性，在很多翻译实验中，会把attention保存起来，建立一个attention的词表来观测不同语种单词之间的对应关系。</li>\n</ul></li>\n</ul>\n<h4 id=\"模型结构定义\">模型结构定义</h4>\n<h5 id=\"encoder\">Encoder</h5>\n<figure>\n<img src=\"/.top//attachment:83f35c9b-6e96-448a-8b04-e70de555a8e4.png\" alt=\"image.png\">\n<figcaption aria-hidden=\"true\">image.png</figcaption>\n</figure>\n<h5 id=\"decoder\">Decoder</h5>\n<ul>\n<li><p>这里为了获得上下文的语义表示，用了双向RNN，包含从sos向eos的前向RNN和从eos向sos的后向RNN，每个状态的表示变为前向RNN的输出和后向RNN的输出的连接\n<span class=\"math inline\">\\([\\vec{h_i}; \\mathop{h_i} \\limits\n^{\\leftarrow}]\\)</span>，这样每个状态都包含了来自前文和后文的语义信息。</p></li>\n<li><p>Encoder的内部由RNN组成，RNN的形式为： <span class=\"math inline\">\\(h_i = RNN(h_{i-1},e(x_i))\\)</span></p></li>\n<li><p>输入为前一个状态表示和这一步的单词的embedding。 <span class=\"math inline\">\\(h_0\\)</span>\n为一个全0矩阵，这里的RNN也可以替换成LSTM或者GRU。待所有的单词输入完毕后，Encoder会计算一个序列整体的表示，这里将前向RNN的最终输出和后向RNN输出的连接\n<span class=\"math inline\">\\([\\vec{h}; \\mathop{h} \\limits\n^{\\leftarrow}]\\)</span>\n传入到一个全连接层进行变换，转换成Decoder输出的大小： <span class=\"math inline\">\\(hidden = tanh(w[\\vec{h}; \\mathop{h} \\limits\n^{\\leftarrow}] + b )\\)</span></p></li>\n<li><p>Encoder函数构建一个encoder，内部RNN使用了torch内置的GRU，参数为：</p>\n<ul>\n<li>input_dim：输入词表的大小</li>\n<li>emb_dim：embedding的维度</li>\n<li>enc_hid_dim：隐藏层的大小</li>\n<li>dropout：dropout的概率</li>\n</ul></li>\n<li><p>forward参数：</p>\n<ul>\n<li>doc：原文数据，是已经由词通过词表转换成序号的数据</li>\n<li>doc_len：每个数据的真实长度，在计算RNN时，可以只计算相应长度的状态，不计算pad符号</li>\n</ul></li>\n<li><p>forword输出Encoder整体的输出，以及Encoder每个状态的输出。每个状态的输出用来计算后续的attention。</p></li>\n<li><p>值得注意的是，为了规避掉后续计算attention时受到序列中存在pad符号的影响，这里应用了nn.utils的pad_paddad_sequence方法，可以去掉doc_len以后的pad符号，这里pad_packed_sequence的输入为单词序列的embedding和序列的真实长度，这样在计算序列时，就不会计算doc_len后的pad符号了。在计算完RNN后，为了形成一个矩阵方便GPU计算，会把每个doc_len\n&lt; max_len\n的序列填充起来，这里使用了pad_packed_sequence方法，输入为RNN计算后的序列packed_outputs，在后续的attention计算时，会把填充的信息规避掉。</p></li>\n</ul>\n<div class=\"sourceCode\" id=\"cb19\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb19-1\"><a href=\"#cb19-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># encoder的输入为原文， 输出为hidden_state, size需设置</span></span>\n<span id=\"cb19-2\"><a href=\"#cb19-2\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Encoder(nn.Module):</span>\n<span id=\"cb19-3\"><a href=\"#cb19-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,input_dim,emb_dim,enc_hid_dim, dec_hid_dim,dropout):</span>\n<span id=\"cb19-4\"><a href=\"#cb19-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb19-5\"><a href=\"#cb19-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb19-6\"><a href=\"#cb19-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义embedding层， 直接使用 torch.nn.Embedding函数</span></span>\n<span id=\"cb19-7\"><a href=\"#cb19-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.embedding <span class=\"op\">=</span> nn.Embedding(input_dim,emb_dim)</span>\n<span id=\"cb19-8\"><a href=\"#cb19-8\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb19-9\"><a href=\"#cb19-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义rnn层， 使用torch.nn.GRU</span></span>\n<span id=\"cb19-10\"><a href=\"#cb19-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.rnn <span class=\"op\">=</span> nn.GRU(emb_dim,enc_hid_dim,bidirectional<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb19-11\"><a href=\"#cb19-11\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb19-12\"><a href=\"#cb19-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义一个 全连接层， 用来 将encoder的输出转换成 decoder输入的大小</span></span>\n<span id=\"cb19-13\"><a href=\"#cb19-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.fc <span class=\"op\">=</span> nn.Linear(enc_hid_dim <span class=\"op\">*</span> <span class=\"dv\">2</span> ,dec_hid_dim)</span>\n<span id=\"cb19-14\"><a href=\"#cb19-14\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb19-15\"><a href=\"#cb19-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义dropout层， 防止过拟合</span></span>\n<span id=\"cb19-16\"><a href=\"#cb19-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.dropout <span class=\"op\">=</span> nn.Dropout(dropout)</span>\n<span id=\"cb19-17\"><a href=\"#cb19-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-18\"><a href=\"#cb19-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,doc,doc_len):</span>\n<span id=\"cb19-19\"><a href=\"#cb19-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        embedded <span class=\"op\">=</span> <span class=\"va\">self</span>.dropout(<span class=\"va\">self</span>.embedding(doc))</span>\n<span id=\"cb19-20\"><a href=\"#cb19-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-21\"><a href=\"#cb19-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        packed_embedded <span class=\"op\">=</span> nn.utils.rnn.pack_padded_sequence(embedded,doc_len)</span>\n<span id=\"cb19-22\"><a href=\"#cb19-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-23\"><a href=\"#cb19-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># packed_outputs 包含了每个RNN中每个状态的输出，如图中的h1,h2,h3...hn</span></span>\n<span id=\"cb19-24\"><a href=\"#cb19-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># hidden只有最后的输出hn</span></span>\n<span id=\"cb19-25\"><a href=\"#cb19-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        packed_outputs, hidden <span class=\"op\">=</span> <span class=\"va\">self</span>.rnn(packed_embedded)</span>\n<span id=\"cb19-26\"><a href=\"#cb19-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-27\"><a href=\"#cb19-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        outputs, _ <span class=\"op\">=</span> nn.utils.rnn.pad_packed_sequence(packed_outputs)</span>\n<span id=\"cb19-28\"><a href=\"#cb19-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-29\"><a href=\"#cb19-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        hidden <span class=\"op\">=</span> torch.tanh(<span class=\"va\">self</span>.fc(torch.cat((hidden[<span class=\"op\">-</span><span class=\"dv\">2</span>,:,:], hidden[<span class=\"op\">-</span><span class=\"dv\">1</span>,:,:]),dim<span class=\"op\">=</span><span class=\"dv\">1</span>)))</span>\n<span id=\"cb19-30\"><a href=\"#cb19-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-31\"><a href=\"#cb19-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> outputs,hidden</span></code></pre></div>\n<h5 id=\"attention\">attention</h5>\n<ul>\n<li><p>attention机制可以建立Decoder的状态 <span class=\"math inline\">\\(s_i\\)</span> 和Encoder每个状态 <span class=\"math inline\">\\(h_j\\)</span> 的关系，如下图所示： <img src=\"/.top//attachment:08055b25-8707-449b-8782-1cf18c9eaf3b.png\" alt=\"image.png\"> 这里计算 <span class=\"math inline\">\\(s_2\\)</span> 和\nEncoder中每个状态的关系，需要用到 <span class=\"math inline\">\\(s_1\\)</span> 的信息，先计算Decoder中 <span class=\"math inline\">\\(s_{i-1}\\)</span> 和 Encodr状态 <span class=\"math inline\">\\(h_{j}\\)</span> 的相似度： <span class=\"math inline\">\\(e_{ij} = a(s_{i-1}, hj)\\)</span> 将 <span class=\"math inline\">\\([s_{i-1};h_{j}]\\)</span>\n传入至一个全连接层计算相似度。 然后将<span class=\"math inline\">\\(s_{i-1}\\)</span> 和\nEncoder中每个状态的相似度做一个softmax变化，得到每个Encoder中每个状态所占的权重，作为attention：\n<span class=\"math inline\">\\(\\alpha_{ij} = \\frac{exp(e_{ij})}{\\sum^{T}_{k\n= 1}(exp(e_{ik}))}\\)</span> attention中的每个权重会用来计算context\nvector，即上下文的向量： <span class=\"math inline\">\\(c_i = \\sum_{k =\n1}^{T} \\alpha_{ij} h_j\\)</span> 这个context\nvector会在Decoder中作为一部分输入。</p></li>\n<li><p>构建Attention类，参数：</p>\n<ul>\n<li>enc_hid_dim：encoder每个位置输出的维度</li>\n<li>dec_hid_dim：decoder每个位置输出的维度</li>\n</ul></li>\n<li><p>forward的参数：</p>\n<ul>\n<li>hidden：decoder里rnn前一个状态的输出</li>\n<li>encoder_outs：encoder里rnn的输出</li>\n<li>mask：mask矩阵，里面存储的是0-1矩阵，0代表被规避的pad符号的位置</li>\n</ul></li>\n<li><p>forword的输出为attention中的每个权重，context\nvector的计算在下面的Decoder类</p></li>\n</ul>\n<div class=\"sourceCode\" id=\"cb20\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb20-1\"><a href=\"#cb20-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Attention(nn.Module):</span>\n<span id=\"cb20-2\"><a href=\"#cb20-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,enc_hid_dim,dec_hid_dim):</span>\n<span id=\"cb20-3\"><a href=\"#cb20-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb20-4\"><a href=\"#cb20-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.attn <span class=\"op\">=</span> nn.Linear((enc_hid_dim <span class=\"op\">*</span> <span class=\"dv\">2</span>) <span class=\"op\">+</span> dec_hid_dim, dec_hid_dim)</span>\n<span id=\"cb20-5\"><a href=\"#cb20-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.v <span class=\"op\">=</span> nn.Linear(dec_hid_dim, <span class=\"dv\">1</span>, bias<span class=\"op\">=</span> <span class=\"va\">False</span>)</span>\n<span id=\"cb20-6\"><a href=\"#cb20-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-7\"><a href=\"#cb20-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,hidden, encoder_outputs, mask):</span>\n<span id=\"cb20-8\"><a href=\"#cb20-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        batch_size <span class=\"op\">=</span> encoder_outputs.shape[<span class=\"dv\">1</span>]</span>\n<span id=\"cb20-9\"><a href=\"#cb20-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        doc_len <span class=\"op\">=</span> encoder_outputs.shape[<span class=\"dv\">0</span>]</span>\n<span id=\"cb20-10\"><a href=\"#cb20-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-11\"><a href=\"#cb20-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 对decoder的状态重复doc_len次，用来计算和每个encoder状态的相似度</span></span>\n<span id=\"cb20-12\"><a href=\"#cb20-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        hidden <span class=\"op\">=</span> hidden.unsqueeze(<span class=\"dv\">1</span>).repeat(<span class=\"dv\">1</span>,doc_len,<span class=\"dv\">1</span>)</span>\n<span id=\"cb20-13\"><a href=\"#cb20-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-14\"><a href=\"#cb20-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs <span class=\"op\">=</span> encoder_outputs.permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>,<span class=\"dv\">2</span>)</span>\n<span id=\"cb20-15\"><a href=\"#cb20-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 使用全连接层计算相似度</span></span>\n<span id=\"cb20-16\"><a href=\"#cb20-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        energy <span class=\"op\">=</span> torch.tanh(<span class=\"va\">self</span>.attn(torch.cat((hidden,encoder_outputs), dim<span class=\"op\">=</span><span class=\"dv\">2</span>)))</span>\n<span id=\"cb20-17\"><a href=\"#cb20-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-18\"><a href=\"#cb20-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 转换尺寸 [batch, doc_len]的形式作为 和每个encoder状态的相似度</span></span>\n<span id=\"cb20-19\"><a href=\"#cb20-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        attention <span class=\"op\">=</span> <span class=\"va\">self</span>.v(energy).squeeze(<span class=\"dv\">2</span>)</span>\n<span id=\"cb20-20\"><a href=\"#cb20-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-21\"><a href=\"#cb20-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 规避encoder里的 pad符号， 将这些位置的权重值降到最低</span></span>\n<span id=\"cb20-22\"><a href=\"#cb20-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        attention <span class=\"op\">=</span> attention.masked_fill(mask <span class=\"op\">==</span><span class=\"dv\">0</span>, <span class=\"op\">-</span><span class=\"fl\">1e10</span>)</span>\n<span id=\"cb20-23\"><a href=\"#cb20-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-24\"><a href=\"#cb20-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 返回权重</span></span>\n<span id=\"cb20-25\"><a href=\"#cb20-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> F.softmax(attention,dim<span class=\"op\">=</span><span class=\"dv\">1</span>)</span></code></pre></div>\n<h4 id=\"decoder-1\">decoder</h4>\n<ul>\n<li>Decoder接收之前的状态信息、输入的单词和context\nvector，预测生成摘要的单词，结构如下所示： <img src=\"/.top//attachment:6a34d1b0-6c17-4fe1-9d24-e521610d0f76.png\" alt=\"image.png\"></li>\n<li>Decoder的RNN与Encoder中的RNN有所不同，输入为[前一步生成单词的embedding;context\nvector]和前一步的状态 hi−1hi−1h_{i-1}，</li>\n<li>目的是引入attention的信息：si=RNN([e(yi−1);c],si−1)si=RNN([e(yi−1);c],si−1)s_i\n= RNN([e(y_{i-1});c],s_{i-1})</li>\n<li>在预测生成的单词时，将context vector、\nRNN的输出状态、前一步生成单词的embedding连接起来输入至全连接层预测：yi=softmax(w[c;si;e(yi−1)]+b)yi=softmax(w[c;si;e(yi−1)]+b)y_i\n= softmax(w[c;s_i;e(y_{i-1})] + b)</li>\n<li>构建Decoder类，参数为：\n<ul>\n<li>output_dim：输出的维度，为词表的长度</li>\n<li>emb_dim：embedding的维度</li>\n<li>enc_hid_dim：encoder每个位置输出的维度</li>\n<li>dec_hid_dim：decoder每个位置输出的维度</li>\n<li>dropout：dropout的概率</li>\n<li>attention：需要传入attention类，用来计算decoder每个位置的输出和encoder每个位置的输出的关系</li>\n</ul></li>\n<li>forword参数：\n<ul>\n<li>input：输入单词的序号</li>\n<li>hidden：上一步Decoder输出的状态</li>\n<li>encoder_outputs：Encoder每个状态的输出，用来计算attention</li>\n<li>mask：mask矩阵，用来在计算attention时，规避pad符号的影响</li>\n</ul></li>\n<li>forword输出为全连接层的输出、这一步Decoder的输出和attention的权重。这里输出的是预测时全连接层的输出，目的是计算后续的损失。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb21\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb21-1\"><a href=\"#cb21-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Decoder(nn.Module):</span>\n<span id=\"cb21-2\"><a href=\"#cb21-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,output_dim,emb_dim,enc_hid_dim,dec_hid_dim,dropout, attention):</span>\n<span id=\"cb21-3\"><a href=\"#cb21-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb21-4\"><a href=\"#cb21-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.output_dim <span class=\"op\">=</span> output_dim</span>\n<span id=\"cb21-5\"><a href=\"#cb21-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.attention <span class=\"op\">=</span> attention</span>\n<span id=\"cb21-6\"><a href=\"#cb21-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-7\"><a href=\"#cb21-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.embedding <span class=\"op\">=</span> nn.Embedding(output_dim,emb_dim)</span>\n<span id=\"cb21-8\"><a href=\"#cb21-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-9\"><a href=\"#cb21-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.rnn <span class=\"op\">=</span> nn.GRU((enc_hid_dim <span class=\"op\">*</span><span class=\"dv\">2</span> )<span class=\"op\">+</span> emb_dim, dec_hid_dim)</span>\n<span id=\"cb21-10\"><a href=\"#cb21-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-11\"><a href=\"#cb21-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.fc_out <span class=\"op\">=</span> nn.Linear((enc_hid_dim <span class=\"op\">*</span> <span class=\"dv\">2</span>)<span class=\"op\">+</span> dec_hid_dim <span class=\"op\">+</span> emb_dim , output_dim)</span>\n<span id=\"cb21-12\"><a href=\"#cb21-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-13\"><a href=\"#cb21-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.dropout <span class=\"op\">=</span> nn.Dropout(dropout)</span>\n<span id=\"cb21-14\"><a href=\"#cb21-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-15\"><a href=\"#cb21-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,<span class=\"bu\">input</span>,hidden,encoder_outputs,mask):</span>\n<span id=\"cb21-16\"><a href=\"#cb21-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">input</span> <span class=\"op\">=</span> <span class=\"bu\">input</span>.unsqueeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-17\"><a href=\"#cb21-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-18\"><a href=\"#cb21-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>        embedded <span class=\"op\">=</span> <span class=\"va\">self</span>.dropout(<span class=\"va\">self</span>.embedding(<span class=\"bu\">input</span>))</span>\n<span id=\"cb21-19\"><a href=\"#cb21-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-20\"><a href=\"#cb21-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        a <span class=\"op\">=</span> <span class=\"va\">self</span>.attention(hidden,encoder_outputs,mask)</span>\n<span id=\"cb21-21\"><a href=\"#cb21-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-22\"><a href=\"#cb21-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        a <span class=\"op\">=</span> a.unsqueeze(<span class=\"dv\">1</span>)</span>\n<span id=\"cb21-23\"><a href=\"#cb21-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-24\"><a href=\"#cb21-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs <span class=\"op\">=</span> encoder_outputs.permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>,<span class=\"dv\">2</span>)</span>\n<span id=\"cb21-25\"><a href=\"#cb21-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-26\"><a href=\"#cb21-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        weighted <span class=\"op\">=</span> torch.bmm(a,encoder_outputs)</span>\n<span id=\"cb21-27\"><a href=\"#cb21-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-28\"><a href=\"#cb21-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        weighted <span class=\"op\">=</span> weighted.permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>,<span class=\"dv\">2</span>)</span>\n<span id=\"cb21-29\"><a href=\"#cb21-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-30\"><a href=\"#cb21-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        rnn_input <span class=\"op\">=</span> torch.cat((embedded, weighted), dim<span class=\"op\">=</span><span class=\"dv\">2</span>)</span>\n<span id=\"cb21-31\"><a href=\"#cb21-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-32\"><a href=\"#cb21-32\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output,hidden <span class=\"op\">=</span> <span class=\"va\">self</span>.rnn(rnn_input, hidden.unsqueeze(<span class=\"dv\">0</span>))</span>\n<span id=\"cb21-33\"><a href=\"#cb21-33\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-34\"><a href=\"#cb21-34\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">assert</span> (output <span class=\"op\">==</span> hidden).<span class=\"bu\">all</span>()</span>\n<span id=\"cb21-35\"><a href=\"#cb21-35\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-36\"><a href=\"#cb21-36\" aria-hidden=\"true\" tabindex=\"-1\"></a>        embedded <span class=\"op\">=</span> embedded.squeeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-37\"><a href=\"#cb21-37\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output <span class=\"op\">=</span> output.squeeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-38\"><a href=\"#cb21-38\" aria-hidden=\"true\" tabindex=\"-1\"></a>        weighted <span class=\"op\">=</span> weighted.squeeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-39\"><a href=\"#cb21-39\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-40\"><a href=\"#cb21-40\" aria-hidden=\"true\" tabindex=\"-1\"></a>        prediction <span class=\"op\">=</span> <span class=\"va\">self</span>.fc_out(torch.cat((output,weighted,embedded), dim<span class=\"op\">=</span><span class=\"dv\">1</span>))</span>\n<span id=\"cb21-41\"><a href=\"#cb21-41\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-42\"><a href=\"#cb21-42\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> prediction,hidden.squeeze(<span class=\"dv\">0</span>),a.squeeze(<span class=\"dv\">1</span>)</span></code></pre></div>\n<h4 id=\"seq2seq\">seq2seq</h4>\n<ul>\n<li>构建一个seq2seq类将encoder、decoder和attention整合起来，参数：\n<ul>\n<li>encoder：encoder类</li>\n<li>decoder：decoder类</li>\n<li>doc_pad_idx：原文词典中pad符号的序号</li>\n<li>device：需要传入的设备</li>\n</ul></li>\n<li>create_mask的参数：\n<ul>\n<li>doc：原文数据，create_mask会根据原文中pad符号的位置构建mask矩阵，这个mask矩阵会传入decoder，可以在计算attention时规避到pad符号的影响</li>\n</ul></li>\n<li>forward的参数：\n<ul>\n<li>doc：传入的一个批次的原文数据，是已经由词转换成序号的数据</li>\n<li>doc_len：一个批次里每个数据的长度，用来生成mask矩阵</li>\n<li>sum：摘要数据，同样已被转换成序号</li>\n<li>teacher_forcing_ratio：teacher_forcing的概率，teacher_forcing是文本生成技术常用的技术，在训练时，如果一个词生成有误差，可能会影响到后面所有的词，所以以一定的概率选择生成的词还是标注的训练数据中相应位置的词，在验证测试时，不会用到teacher_forcing</li>\n</ul></li>\n</ul>\n<div class=\"sourceCode\" id=\"cb22\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb22-1\"><a href=\"#cb22-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Seq2Seq(nn.Module):</span>\n<span id=\"cb22-2\"><a href=\"#cb22-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,encoder,decoder,doc_pad_idx,device):</span>\n<span id=\"cb22-3\"><a href=\"#cb22-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb22-4\"><a href=\"#cb22-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-5\"><a href=\"#cb22-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.encoder <span class=\"op\">=</span> encoder</span>\n<span id=\"cb22-6\"><a href=\"#cb22-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.decoder <span class=\"op\">=</span> decoder</span>\n<span id=\"cb22-7\"><a href=\"#cb22-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.doc_pad_idx <span class=\"op\">=</span> doc_pad_idx</span>\n<span id=\"cb22-8\"><a href=\"#cb22-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.device <span class=\"op\">=</span> device</span>\n<span id=\"cb22-9\"><a href=\"#cb22-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-10\"><a href=\"#cb22-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> create_mask(<span class=\"va\">self</span>,doc):</span>\n<span id=\"cb22-11\"><a href=\"#cb22-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>        mask <span class=\"op\">=</span> (doc <span class=\"op\">!=</span> <span class=\"va\">self</span>.doc_pad_idx).permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>)</span>\n<span id=\"cb22-12\"><a href=\"#cb22-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> mask</span>\n<span id=\"cb22-13\"><a href=\"#cb22-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb22-14\"><a href=\"#cb22-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,doc,doc_len,<span class=\"bu\">sum</span>, teacher_forcing_ratio<span class=\"op\">=</span><span class=\"fl\">0.5</span>):</span>\n<span id=\"cb22-15\"><a href=\"#cb22-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        batch_size <span class=\"op\">=</span> doc.shape[<span class=\"dv\">1</span>]</span>\n<span id=\"cb22-16\"><a href=\"#cb22-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-17\"><a href=\"#cb22-17\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(type(sum))</span></span>\n<span id=\"cb22-18\"><a href=\"#cb22-18\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(sum)</span></span>\n<span id=\"cb22-19\"><a href=\"#cb22-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_len <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>].shape[<span class=\"dv\">0</span>]</span>\n<span id=\"cb22-20\"><a href=\"#cb22-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_vocab_size<span class=\"op\">=</span> <span class=\"va\">self</span>.decoder.output_dim</span>\n<span id=\"cb22-21\"><a href=\"#cb22-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-22\"><a href=\"#cb22-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义一个tensor来存储每一个生成的单词序号</span></span>\n<span id=\"cb22-23\"><a href=\"#cb22-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        outputs <span class=\"op\">=</span> torch.zeros(sum_len,batch_size,sum_vocab_size).to(<span class=\"va\">self</span>.device)</span>\n<span id=\"cb22-24\"><a href=\"#cb22-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-25\"><a href=\"#cb22-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># encoder_outputs 是 encoder所有的输出状态</span></span>\n<span id=\"cb22-26\"><a href=\"#cb22-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># hidder是 encoder整体的输出</span></span>\n<span id=\"cb22-27\"><a href=\"#cb22-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs , hidden <span class=\"op\">=</span> <span class=\"va\">self</span>.encoder(doc,doc_len)</span>\n<span id=\"cb22-28\"><a href=\"#cb22-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-29\"><a href=\"#cb22-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 输入的第一个字符为&lt;sos&gt;</span></span>\n<span id=\"cb22-30\"><a href=\"#cb22-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">input</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>][<span class=\"dv\">0</span>,:]</span>\n<span id=\"cb22-31\"><a href=\"#cb22-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-32\"><a href=\"#cb22-32\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 构建一个mask矩阵， 包含训练数据原文中 pad符号的位置</span></span>\n<span id=\"cb22-33\"><a href=\"#cb22-33\" aria-hidden=\"true\" tabindex=\"-1\"></a>        mask <span class=\"op\">=</span> <span class=\"va\">self</span>.create_mask(doc)</span>\n<span id=\"cb22-34\"><a href=\"#cb22-34\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-35\"><a href=\"#cb22-35\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">for</span> t <span class=\"kw\">in</span> <span class=\"bu\">range</span>(<span class=\"dv\">1</span>, sum_len):</span>\n<span id=\"cb22-36\"><a href=\"#cb22-36\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">try</span>:</span>\n<span id=\"cb22-37\"><a href=\"#cb22-37\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># decoder 输入 前一步生成的单词embedding, 前一步状态hidden, encoder所有状态以及mask矩阵</span></span>\n<span id=\"cb22-38\"><a href=\"#cb22-38\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 返回预测全连接层的输出和这一步的状态</span></span>\n<span id=\"cb22-39\"><a href=\"#cb22-39\" aria-hidden=\"true\" tabindex=\"-1\"></a>                output,hidden,_ <span class=\"op\">=</span> <span class=\"va\">self</span>.decoder(<span class=\"bu\">input</span>,hidden,encoder_outputs,mask)</span>\n<span id=\"cb22-40\"><a href=\"#cb22-40\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-41\"><a href=\"#cb22-41\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 把output的信息存储在之前定义的 outputs里</span></span>\n<span id=\"cb22-42\"><a href=\"#cb22-42\" aria-hidden=\"true\" tabindex=\"-1\"></a>                outputs[t] <span class=\"op\">=</span> output</span>\n<span id=\"cb22-43\"><a href=\"#cb22-43\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-44\"><a href=\"#cb22-44\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 生成一个随机数， 来决定是否使用 teacher forcing</span></span>\n<span id=\"cb22-45\"><a href=\"#cb22-45\" aria-hidden=\"true\" tabindex=\"-1\"></a>                teacher_force <span class=\"op\">=</span> random.random() <span class=\"op\">&lt;</span> teacher_forcing_ratio</span>\n<span id=\"cb22-46\"><a href=\"#cb22-46\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-47\"><a href=\"#cb22-47\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 获得可能性最高的单词序号 作为生成的单词</span></span>\n<span id=\"cb22-48\"><a href=\"#cb22-48\" aria-hidden=\"true\" tabindex=\"-1\"></a>                top1 <span class=\"op\">=</span> output.argmax(<span class=\"dv\">1</span>)</span>\n<span id=\"cb22-49\"><a href=\"#cb22-49\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-50\"><a href=\"#cb22-50\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 如果使用teacher forcing则用训练数据相应位置的单词</span></span>\n<span id=\"cb22-51\"><a href=\"#cb22-51\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 否则使用生成的单词 作为下一步的输入单词</span></span>\n<span id=\"cb22-52\"><a href=\"#cb22-52\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"bu\">input</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[t] <span class=\"cf\">if</span> teacher_force <span class=\"cf\">else</span> top1</span>\n<span id=\"cb22-53\"><a href=\"#cb22-53\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">except</span> <span class=\"pp\">Exception</span> <span class=\"im\">as</span> e:</span>\n<span id=\"cb22-54\"><a href=\"#cb22-54\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"cf\">pass</span></span>\n<span id=\"cb22-55\"><a href=\"#cb22-55\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> outputs      </span></code></pre></div>\n<h3 id=\"模型实例化\">模型实例化</h3>\n<p>利用定义好的模型结构实例化encoder和decoder。</p>\n<div class=\"sourceCode\" id=\"cb23\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb23-1\"><a href=\"#cb23-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>INPUT_DIM <span class=\"op\">=</span> <span class=\"bu\">len</span>(DOCUMENT.vocab)</span>\n<span id=\"cb23-2\"><a href=\"#cb23-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>OUTPUT_DIM <span class=\"op\">=</span> <span class=\"bu\">len</span>(SUMMARY.vocab)</span>\n<span id=\"cb23-3\"><a href=\"#cb23-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>ENC_EMB_DIM <span class=\"op\">=</span> <span class=\"dv\">256</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-4\"><a href=\"#cb23-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>DEC_EMB_DIM <span class=\"op\">=</span> <span class=\"dv\">256</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-5\"><a href=\"#cb23-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>ENC_HID_DIM <span class=\"op\">=</span> <span class=\"dv\">512</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-6\"><a href=\"#cb23-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>DEC_HID_DIM <span class=\"op\">=</span> <span class=\"dv\">512</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-7\"><a href=\"#cb23-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>ENC_DROPOUT <span class=\"op\">=</span> <span class=\"fl\">0.5</span></span>\n<span id=\"cb23-8\"><a href=\"#cb23-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>DEC_DROPOUT <span class=\"op\">=</span> <span class=\"fl\">0.5</span></span>\n<span id=\"cb23-9\"><a href=\"#cb23-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOC_PAD_IDX <span class=\"op\">=</span> DOCUMENT.vocab.stoi[DOCUMENT.pad_token]</span>\n<span id=\"cb23-10\"><a href=\"#cb23-10\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb23-11\"><a href=\"#cb23-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>attn <span class=\"op\">=</span> Attention(ENC_HID_DIM,DEC_HID_DIM)</span>\n<span id=\"cb23-12\"><a href=\"#cb23-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>enc <span class=\"op\">=</span> Encoder(INPUT_DIM,ENC_EMB_DIM,ENC_HID_DIM,DEC_HID_DIM,ENC_DROPOUT)</span>\n<span id=\"cb23-13\"><a href=\"#cb23-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>dec <span class=\"op\">=</span> Decoder(OUTPUT_DIM,DEC_EMB_DIM,ENC_HID_DIM,DEC_HID_DIM,DEC_DROPOUT,attn)</span>\n<span id=\"cb23-14\"><a href=\"#cb23-14\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb23-15\"><a href=\"#cb23-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>model <span class=\"op\">=</span> Seq2Seq(enc,dec,DOC_PAD_IDX,device).to(device)</span></code></pre></div>\n<h4 id=\"查看模型\">查看模型</h4>\n<div class=\"sourceCode\" id=\"cb24\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb24-1\"><a href=\"#cb24-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>model</span></code></pre></div>\n<pre><code>Seq2Seq(\n  (encoder): Encoder(\n    (embedding): Embedding(16555, 4)\n    (rnn): GRU(4, 8, bidirectional=True)\n    (fc): Linear(in_features=16, out_features=8, bias=True)\n    (dropout): Dropout(p=0.5, inplace=False)\n  )\n  (decoder): Decoder(\n    (attention): Attention(\n      (attn): Linear(in_features=24, out_features=8, bias=True)\n      (v): Linear(in_features=8, out_features=1, bias=False)\n    )\n    (embedding): Embedding(9267, 4)\n    (rnn): GRU(20, 8)\n    (fc_out): Linear(in_features=28, out_features=9267, bias=True)\n    (dropout): Dropout(p=0.5, inplace=False)\n  )\n)</code></pre>\n<h3 id=\"模型训练\">模型训练</h3>\n<ul>\n<li>使用之前处理的训练数据对模型训练，主要包括\n<ul>\n<li>定义训练函数</li>\n<li>定义验证函数</li>\n<li>定义时间显示函数</li>\n<li>训练过程</li>\n<li>模型保存</li>\n</ul></li>\n</ul>\n<h4 id=\"定义训练函数\">定义训练函数</h4>\n<p>定义训练一个 epoch的函数，并返回损失，参数 - model: 用以训练的模型 -\niteration: 用以训练的数据迭代器 - optimizer: 训练模型使用的优化器 -\ncriterion: 训练模型使用的损失函数 - clip: 梯度截断的值，\n传入torch.nn.utils.clip_grad_norm_中，如果梯度超过这个clip，会使用clip对梯度进行截断，可以预防训练初期的梯度爆炸现象。</p>\n<h4 id=\"定义验证函数\">定义验证函数</h4>\n<p>返回测试/验证数据的损失， 参数： - model: 用以验证的模型 - iteration:\n用以验证/测试的数据迭代器 - criterion: 验证/测试模型的损失函数</p>\n<div class=\"sourceCode\" id=\"cb26\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb26-1\"><a href=\"#cb26-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> train(model,iterator,optimizer,criterion,clip):</span>\n<span id=\"cb26-2\"><a href=\"#cb26-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    model.train()</span>\n<span id=\"cb26-3\"><a href=\"#cb26-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb26-4\"><a href=\"#cb26-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    epoch_loss <span class=\"op\">=</span> <span class=\"dv\">0</span></span>\n<span id=\"cb26-5\"><a href=\"#cb26-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb26-6\"><a href=\"#cb26-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">for</span> i,batch <span class=\"kw\">in</span> <span class=\"bu\">enumerate</span>(iterator):</span>\n<span id=\"cb26-7\"><a href=\"#cb26-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        doc,doc_len <span class=\"op\">=</span> batch.document</span>\n<span id=\"cb26-8\"><a href=\"#cb26-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">sum</span> <span class=\"op\">=</span> batch.summary</span>\n<span id=\"cb26-9\"><a href=\"#cb26-9\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(&quot;****************这是train************************&quot;)</span></span>\n<span id=\"cb26-10\"><a href=\"#cb26-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(type(sum))</span></span>\n<span id=\"cb26-11\"><a href=\"#cb26-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(sum)</span></span>\n<span id=\"cb26-12\"><a href=\"#cb26-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        optimizer.zero_grad()</span>\n<span id=\"cb26-13\"><a href=\"#cb26-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-14\"><a href=\"#cb26-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output <span class=\"op\">=</span> model(doc,doc_len,<span class=\"bu\">sum</span>)</span>\n<span id=\"cb26-15\"><a href=\"#cb26-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-16\"><a href=\"#cb26-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output_dim <span class=\"op\">=</span> output.shape[<span class=\"op\">-</span><span class=\"dv\">1</span>]</span>\n<span id=\"cb26-17\"><a href=\"#cb26-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-18\"><a href=\"#cb26-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output <span class=\"op\">=</span> output[<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>,output_dim)</span>\n<span id=\"cb26-19\"><a href=\"#cb26-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">sum</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>][<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>)</span>\n<span id=\"cb26-20\"><a href=\"#cb26-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-21\"><a href=\"#cb26-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        loss <span class=\"op\">=</span> criterion(output,<span class=\"bu\">sum</span>)</span>\n<span id=\"cb26-22\"><a href=\"#cb26-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-23\"><a href=\"#cb26-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        loss.backward()</span>\n<span id=\"cb26-24\"><a href=\"#cb26-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-25\"><a href=\"#cb26-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        torch.nn.utils.clip_grad_norm_(model.parameters(),clip)</span>\n<span id=\"cb26-26\"><a href=\"#cb26-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-27\"><a href=\"#cb26-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        optimizer.step()</span>\n<span id=\"cb26-28\"><a href=\"#cb26-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-29\"><a href=\"#cb26-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        epoch_loss <span class=\"op\">+=</span> loss.item()</span>\n<span id=\"cb26-30\"><a href=\"#cb26-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">if</span> i<span class=\"op\">&gt;</span><span class=\"dv\">20</span>:<span class=\"cf\">break</span></span>\n<span id=\"cb26-31\"><a href=\"#cb26-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> epoch_loss <span class=\"op\">/</span> <span class=\"bu\">len</span>(iterator)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb27\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb27-1\"><a href=\"#cb27-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> evaluate(model,iterator,criterion):</span>\n<span id=\"cb27-2\"><a href=\"#cb27-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    model.<span class=\"bu\">eval</span>()</span>\n<span id=\"cb27-3\"><a href=\"#cb27-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb27-4\"><a href=\"#cb27-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    epoch_loss <span class=\"op\">=</span> <span class=\"dv\">0</span></span>\n<span id=\"cb27-5\"><a href=\"#cb27-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">with</span> torch.no_grad():</span>\n<span id=\"cb27-6\"><a href=\"#cb27-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">for</span> i,batch <span class=\"kw\">in</span> <span class=\"bu\">enumerate</span>(iterator):</span>\n<span id=\"cb27-7\"><a href=\"#cb27-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>            doc,doc_len <span class=\"op\">=</span> batch.document</span>\n<span id=\"cb27-8\"><a href=\"#cb27-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"bu\">sum</span> <span class=\"op\">=</span> batch.summary</span>\n<span id=\"cb27-9\"><a href=\"#cb27-9\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#             print(&quot;****************这是evaluate************************&quot;)</span></span>\n<span id=\"cb27-10\"><a href=\"#cb27-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#             print(type(sum))</span></span>\n<span id=\"cb27-11\"><a href=\"#cb27-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#             print(sum)</span></span>\n<span id=\"cb27-12\"><a href=\"#cb27-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output <span class=\"op\">=</span> model(doc,doc_len,<span class=\"bu\">sum</span>,<span class=\"dv\">0</span>)</span>\n<span id=\"cb27-13\"><a href=\"#cb27-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-14\"><a href=\"#cb27-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output_dim <span class=\"op\">=</span> output.shape[<span class=\"op\">-</span><span class=\"dv\">1</span>]</span>\n<span id=\"cb27-15\"><a href=\"#cb27-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-16\"><a href=\"#cb27-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output <span class=\"op\">=</span> output[<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>,output_dim)</span>\n<span id=\"cb27-17\"><a href=\"#cb27-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"bu\">sum</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>][<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>)</span>\n<span id=\"cb27-18\"><a href=\"#cb27-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-19\"><a href=\"#cb27-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>            loss <span class=\"op\">=</span> criterion(output,<span class=\"bu\">sum</span>)</span>\n<span id=\"cb27-20\"><a href=\"#cb27-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-21\"><a href=\"#cb27-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>            epoch_loss <span class=\"op\">+=</span> loss.item()</span>\n<span id=\"cb27-22\"><a href=\"#cb27-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">if</span> i<span class=\"op\">&gt;</span><span class=\"dv\">20</span>:<span class=\"cf\">break</span></span>\n<span id=\"cb27-23\"><a href=\"#cb27-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> epoch_loss <span class=\"op\">/</span> <span class=\"bu\">len</span>(iterator)</span></code></pre></div>\n<h4 id=\"定义时间显示的函数\">定义时间显示的函数</h4>\n<div class=\"sourceCode\" id=\"cb28\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb28-1\"><a href=\"#cb28-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> epoch_time(start_time,end_time):</span>\n<span id=\"cb28-2\"><a href=\"#cb28-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    elapsed_time <span class=\"op\">=</span> end_time <span class=\"op\">-</span>start_time</span>\n<span id=\"cb28-3\"><a href=\"#cb28-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    elapsed_mins <span class=\"op\">=</span> <span class=\"bu\">int</span>(elapsed_time <span class=\"op\">/</span> <span class=\"dv\">60</span>)</span>\n<span id=\"cb28-4\"><a href=\"#cb28-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    elapsed_secs <span class=\"op\">=</span> <span class=\"bu\">int</span>(elapsed_time <span class=\"op\">-</span>(elapsed_mins <span class=\"op\">*</span> <span class=\"dv\">60</span>))</span>\n<span id=\"cb28-5\"><a href=\"#cb28-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> elapsed_mins,elapsed_secs</span></code></pre></div>\n<h4 id=\"训练过程\">训练过程</h4>\n<p>对整体的数据训练，分多个批次训练。 -\n训练过程中，每个epoch后输出耗时、训练损失和验证损失。 -\n这里只训练了5个epoch，训练使用adam学习器，的学习率lr设置为0.001，weight\ndecay设置为0.0001，CLIP设置为1。 -\n训练使用CrossEntropyLoss交叉熵损失，代表生成摘要每个位置单词和训练数据中相应位置的差异，如果训练数据中某个位置为pad符号，则计算损失时不计算生成摘要该位置的单词的损失。</p>\n<div class=\"sourceCode\" id=\"cb29\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb29-1\"><a href=\"#cb29-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>N_EPOCHS <span class=\"op\">=</span> <span class=\"dv\">1</span></span>\n<span id=\"cb29-2\"><a href=\"#cb29-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>CLIP <span class=\"op\">=</span> <span class=\"dv\">1</span></span>\n<span id=\"cb29-3\"><a href=\"#cb29-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>lr<span class=\"op\">=</span> <span class=\"fl\">0.001</span></span>\n<span id=\"cb29-4\"><a href=\"#cb29-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>weight_decay <span class=\"op\">=</span> <span class=\"fl\">0.0001</span></span>\n<span id=\"cb29-5\"><a href=\"#cb29-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>SUM_PAD_IDX <span class=\"op\">=</span> SUMMARY.vocab.stoi[SUMMARY.pad_token]</span>\n<span id=\"cb29-6\"><a href=\"#cb29-6\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb29-7\"><a href=\"#cb29-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>criterion <span class=\"op\">=</span> nn.CrossEntropyLoss(ignore_index<span class=\"op\">=</span>SUM_PAD_IDX)</span>\n<span id=\"cb29-8\"><a href=\"#cb29-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>optimizer <span class=\"op\">=</span> optim.Adam(model.parameters(),lr<span class=\"op\">=</span>lr,weight_decay<span class=\"op\">=</span>weight_decay)</span>\n<span id=\"cb29-9\"><a href=\"#cb29-9\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb29-10\"><a href=\"#cb29-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 训练</span></span>\n<span id=\"cb29-11\"><a href=\"#cb29-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">for</span> epoch <span class=\"kw\">in</span> <span class=\"bu\">range</span>(N_EPOCHS):</span>\n<span id=\"cb29-12\"><a href=\"#cb29-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>    start_time <span class=\"op\">=</span> time.time()</span>\n<span id=\"cb29-13\"><a href=\"#cb29-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-14\"><a href=\"#cb29-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>    train_loss <span class=\"op\">=</span> train(model,train_iter, optimizer, criterion,CLIP)</span>\n<span id=\"cb29-15\"><a href=\"#cb29-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>    valid_loss <span class=\"op\">=</span> evaluate(model,val_iter,criterion)</span>\n<span id=\"cb29-16\"><a href=\"#cb29-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-17\"><a href=\"#cb29-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>    end_time <span class=\"op\">=</span> time.time()</span>\n<span id=\"cb29-18\"><a href=\"#cb29-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-19\"><a href=\"#cb29-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>    epoch_mins,epoch_secs <span class=\"op\">=</span> epoch_time(start_time,end_time)</span>\n<span id=\"cb29-20\"><a href=\"#cb29-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-21\"><a href=\"#cb29-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"ss\">f&#39;Epoch: </span><span class=\"sc\">&#123;</span>epoch <span class=\"op\">+</span> <span class=\"dv\">1</span><span class=\"sc\">:02&#125;</span><span class=\"ss\"> | Time:</span><span class=\"sc\">&#123;</span>epoch_mins<span class=\"sc\">&#125;</span><span class=\"ss\">m </span><span class=\"sc\">&#123;</span>epoch_secs<span class=\"sc\">&#125;</span><span class=\"ss\">s&#39;</span>)</span>\n<span id=\"cb29-22\"><a href=\"#cb29-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"ss\">f&#39;</span><span class=\"ch\">\\t</span><span class=\"ss\">Train Loss: </span><span class=\"sc\">&#123;</span>train_loss <span class=\"sc\">:.3f&#125;</span><span class=\"ss\"> | Tain PPL:</span><span class=\"sc\">&#123;</span>math<span class=\"sc\">.</span>exp(train_loss)<span class=\"sc\">:7.3f&#125;</span><span class=\"ss\">&#39;</span>)</span>\n<span id=\"cb29-23\"><a href=\"#cb29-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"ss\">f&#39;</span><span class=\"ch\">\\t</span><span class=\"ss\"> Val. Loss: </span><span class=\"sc\">&#123;</span>valid_loss<span class=\"sc\">:.3f&#125;</span><span class=\"ss\"> |  Val. PPL: </span><span class=\"sc\">&#123;</span>math<span class=\"sc\">.</span>exp(valid_loss)<span class=\"sc\">:7.3f&#125;</span><span class=\"ss\">&#39;</span>)</span></code></pre></div>\n<pre><code>Epoch: 01 | Time:0m 1s\n    Train Loss: 0.050 | Tain PPL:  1.052\n     Val. Loss: 0.999 |  Val. PPL:   2.716</code></pre>\n<h4 id=\"模型保存\">模型保存</h4>\n<div class=\"sourceCode\" id=\"cb31\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb31-1\"><a href=\"#cb31-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>torch.save(model.state_dict(),<span class=\"st\">&#39;model.pt&#39;</span>)</span></code></pre></div>\n<h3 id=\"模型预测\">模型预测</h3>\n<ul>\n<li>模型加载</li>\n<li>构建预测函数</li>\n<li>读取数据</li>\n<li>预测</li>\n</ul>\n<h4 id=\"模型加载\">模型加载</h4>\n<div class=\"sourceCode\" id=\"cb32\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb32-1\"><a href=\"#cb32-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>model.load_state_dict(torch.load(<span class=\"st\">&#39;model.pt&#39;</span>))</span></code></pre></div>\n<pre><code>&lt;All keys matched successfully&gt;</code></pre>\n<h4 id=\"构建预测函数\">构建预测函数</h4>\n<p>构建生成的函数，输入原文的字符串，输出生成摘要的字符串，参数为： -\ndoc_sentence:摘要的字符串 -\ndoc_field:之前定义的针对document的预处理格式DOCUMENT -\nsum_field:之前定义的针对summary的预处理格式SUMMARY -\nmodel:训练的seq2seq模型 - device:数据存放的设备 -\nmax_len:生成摘要的最长长度</p>\n<div class=\"sourceCode\" id=\"cb34\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb34-1\"><a href=\"#cb34-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> generate_summary(doc_sentence,doc_field,sum_field,model,device,max_len<span class=\"op\">=</span><span class=\"dv\">50</span>):</span>\n<span id=\"cb34-2\"><a href=\"#cb34-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 将模型部署为验证模式</span></span>\n<span id=\"cb34-3\"><a href=\"#cb34-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    model.<span class=\"bu\">eval</span>()</span>\n<span id=\"cb34-4\"><a href=\"#cb34-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-5\"><a href=\"#cb34-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 对原文分词</span></span>\n<span id=\"cb34-6\"><a href=\"#cb34-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    nlp <span class=\"op\">=</span> spacy.load(<span class=\"st\">&#39;en_core_web_sm&#39;</span>)</span>\n<span id=\"cb34-7\"><a href=\"#cb34-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-8\"><a href=\"#cb34-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>    tokens <span class=\"op\">=</span> [token.text.lower() <span class=\"cf\">for</span> token <span class=\"kw\">in</span> nlp(doc_sentence)]</span>\n<span id=\"cb34-9\"><a href=\"#cb34-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-10\"><a href=\"#cb34-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 为原文加上起始符号&lt;sos&gt; 和结束符号&lt;eos&gt;</span></span>\n<span id=\"cb34-11\"><a href=\"#cb34-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>    tokens <span class=\"op\">=</span> [doc_field.init_token] <span class=\"op\">+</span> tokens <span class=\"op\">+</span> [doc_field.eos_token]</span>\n<span id=\"cb34-12\"><a href=\"#cb34-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-13\"><a href=\"#cb34-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 将字符转换为序号</span></span>\n<span id=\"cb34-14\"><a href=\"#cb34-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>    doc_indexes <span class=\"op\">=</span> [doc_field.vocab.stoi[token] <span class=\"cf\">for</span> token <span class=\"kw\">in</span> tokens]</span>\n<span id=\"cb34-15\"><a href=\"#cb34-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-16\"><a href=\"#cb34-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 转换成可以gpu计算的tensor</span></span>\n<span id=\"cb34-17\"><a href=\"#cb34-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>    doc_tensor <span class=\"op\">=</span> torch.LongTensor(doc_indexes).unsqueeze(<span class=\"dv\">1</span>).to(device)</span>\n<span id=\"cb34-18\"><a href=\"#cb34-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-19\"><a href=\"#cb34-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>    doc_len <span class=\"op\">=</span> torch.LongTensor([<span class=\"bu\">len</span>(doc_indexes)]).to(device)</span>\n<span id=\"cb34-20\"><a href=\"#cb34-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-21\"><a href=\"#cb34-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 计算encoder</span></span>\n<span id=\"cb34-22\"><a href=\"#cb34-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">with</span> torch.no_grad():</span>\n<span id=\"cb34-23\"><a href=\"#cb34-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs,hidden <span class=\"op\">=</span> model.encoder(doc_tensor,doc_len)</span>\n<span id=\"cb34-24\"><a href=\"#cb34-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-25\"><a href=\"#cb34-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>    mask <span class=\"op\">=</span> model.create_mask(doc_tensor)</span>\n<span id=\"cb34-26\"><a href=\"#cb34-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-27\"><a href=\"#cb34-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 生成摘要的一个单词&lt;sos&gt;</span></span>\n<span id=\"cb34-28\"><a href=\"#cb34-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>    sum_indexes <span class=\"op\">=</span> [sum_field.vocab.stoi[sum_field.init_token]]</span>\n<span id=\"cb34-29\"><a href=\"#cb34-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-30\"><a href=\"#cb34-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 构建一个attention tensor，存储每一步的attention</span></span>\n<span id=\"cb34-31\"><a href=\"#cb34-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>    attentions <span class=\"op\">=</span> torch.zeros(max_len,<span class=\"dv\">1</span>,<span class=\"bu\">len</span>(doc_indexes)).to(device)</span>\n<span id=\"cb34-32\"><a href=\"#cb34-32\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-33\"><a href=\"#cb34-33\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">for</span> i <span class=\"kw\">in</span> <span class=\"bu\">range</span>(max_len):</span>\n<span id=\"cb34-34\"><a href=\"#cb34-34\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_tensor <span class=\"op\">=</span> torch.LongTensor([sum_indexes[<span class=\"op\">-</span><span class=\"dv\">1</span>]]).to(device)</span>\n<span id=\"cb34-35\"><a href=\"#cb34-35\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-36\"><a href=\"#cb34-36\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 计算每一步的decoder</span></span>\n<span id=\"cb34-37\"><a href=\"#cb34-37\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">with</span> torch.no_grad():</span>\n<span id=\"cb34-38\"><a href=\"#cb34-38\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output,hidden,attention <span class=\"op\">=</span> model.decoder(sum_tensor, hidden, encoder_outputs,mask)</span>\n<span id=\"cb34-39\"><a href=\"#cb34-39\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb34-40\"><a href=\"#cb34-40\" aria-hidden=\"true\" tabindex=\"-1\"></a>        attentions[i] <span class=\"op\">=</span> attention</span>\n<span id=\"cb34-41\"><a href=\"#cb34-41\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-42\"><a href=\"#cb34-42\" aria-hidden=\"true\" tabindex=\"-1\"></a>        pred_token <span class=\"op\">=</span> output.argmax(<span class=\"dv\">1</span>).item()</span>\n<span id=\"cb34-43\"><a href=\"#cb34-43\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-44\"><a href=\"#cb34-44\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 如果出现了 &lt;eos&gt; 则直接结束计算</span></span>\n<span id=\"cb34-45\"><a href=\"#cb34-45\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">if</span> pred_token <span class=\"op\">==</span> sum_field.vocab.stoi[sum_field.eos_token]:</span>\n<span id=\"cb34-46\"><a href=\"#cb34-46\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">break</span></span>\n<span id=\"cb34-47\"><a href=\"#cb34-47\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-48\"><a href=\"#cb34-48\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_indexes.append(pred_token)</span>\n<span id=\"cb34-49\"><a href=\"#cb34-49\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-50\"><a href=\"#cb34-50\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 把序号转换成单词</span></span>\n<span id=\"cb34-51\"><a href=\"#cb34-51\" aria-hidden=\"true\" tabindex=\"-1\"></a>    sum_tokens <span class=\"op\">=</span> [sum_field.vocab.itos[i] <span class=\"cf\">for</span> i <span class=\"kw\">in</span> sum_indexes]</span>\n<span id=\"cb34-52\"><a href=\"#cb34-52\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-53\"><a href=\"#cb34-53\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> sum_tokens[<span class=\"dv\">1</span>:], attentions[:<span class=\"bu\">len</span>(sum_tokens)<span class=\"op\">-</span><span class=\"dv\">1</span>]</span></code></pre></div>\n<h4 id=\"读取数据\">读取数据</h4>\n<div class=\"sourceCode\" id=\"cb35\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb35-1\"><a href=\"#cb35-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_test <span class=\"op\">=</span> pd.read_csv(<span class=\"st\">&quot;dataset/test.csv&quot;</span>,encoding<span class=\"op\">=</span><span class=\"st\">&#39;utf-8&#39;</span>)</span>\n<span id=\"cb35-2\"><a href=\"#cb35-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_test <span class=\"op\">=</span> data_test[:<span class=\"dv\">100</span>]</span>\n<span id=\"cb35-3\"><a href=\"#cb35-3\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb35-4\"><a href=\"#cb35-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>doc_sentence_list <span class=\"op\">=</span> data_test[<span class=\"st\">&#39;document&#39;</span>].tolist()</span>\n<span id=\"cb35-5\"><a href=\"#cb35-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>sum_sentence_list <span class=\"op\">=</span> data_test[<span class=\"st\">&#39;summary&#39;</span>].tolist()</span></code></pre></div>\n<h4 id=\"预测\">预测</h4>\n<div class=\"sourceCode\" id=\"cb36\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb36-1\"><a href=\"#cb36-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 使用generate_summary函数对测试集中所有的document生成摘要, 预测时，不能使用批次的方式预测，所有数据顺序预测，需要一定的时间。</span></span>\n<span id=\"cb36-2\"><a href=\"#cb36-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>generated_summary <span class=\"op\">=</span> []</span>\n<span id=\"cb36-3\"><a href=\"#cb36-3\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">for</span> doc_sentence <span class=\"kw\">in</span> doc_sentence_list:</span>\n<span id=\"cb36-4\"><a href=\"#cb36-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    summary_words,attention <span class=\"op\">=</span> generate_summary(doc_sentence,DOCUMENT,SUMMARY,model,device,max_len<span class=\"op\">=</span><span class=\"dv\">50</span>)</span>\n<span id=\"cb36-5\"><a href=\"#cb36-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    summary_sentence <span class=\"op\">=</span> (<span class=\"st\">&#39; &#39;</span>).join(summary_words)</span>\n<span id=\"cb36-6\"><a href=\"#cb36-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    generated_summary.append(summary_sentence)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb37\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb37-1\"><a href=\"#cb37-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 输出一个生成的摘要</span></span>\n<span id=\"cb37-2\"><a href=\"#cb37-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>indices <span class=\"op\">=</span> random.sample(<span class=\"bu\">range</span>(<span class=\"dv\">0</span>,<span class=\"bu\">len</span>(sum_sentence_list)),<span class=\"dv\">5</span>)</span>\n<span id=\"cb37-3\"><a href=\"#cb37-3\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">for</span> index <span class=\"kw\">in</span> indices:</span>\n<span id=\"cb37-4\"><a href=\"#cb37-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;******document******&quot;</span>)</span>\n<span id=\"cb37-5\"><a href=\"#cb37-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(doc_sentence_list[index])</span>\n<span id=\"cb37-6\"><a href=\"#cb37-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb37-7\"><a href=\"#cb37-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;******generated summary:*******&quot;</span>)</span>\n<span id=\"cb37-8\"><a href=\"#cb37-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(generated_summary[index])</span>\n<span id=\"cb37-9\"><a href=\"#cb37-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb37-10\"><a href=\"#cb37-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;*******reference summary:*******&quot;</span>)</span>\n<span id=\"cb37-11\"><a href=\"#cb37-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(sum_sentence_list[index])</span>\n<span id=\"cb37-12\"><a href=\"#cb37-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb37-13\"><a href=\"#cb37-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;***************************&quot;</span>)</span></code></pre></div>\n<pre><code>******document******\nsouth african mining giant anglo american said on tuesday that it had agreed to sell the &lt;unk&gt; &lt;unk&gt; group for ### million dollars -lrb- ### million euros -rrb- in cash to private equity group advent international .\n******generated summary:*******\ncommunity pilgrims organizers qualifiers nt thailand descends number village village village village vie profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile\n*******reference summary:*******\nanglo american sells &lt;unk&gt; &lt;unk&gt; for ### mln dlrs\n***************************\n******document******\nthe patriots locked up super bowl hero adam vinatieri friday , removing the `` franchise player &#39;&#39; tag and signing him to a three-year deal , and now they will wait to see if there is any interest in a drew bledsoe deal at the owners &#39; meetings in orlando this upcoming week .\n******generated summary:*******\ndescends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open\n*******reference summary:*******\npats sign vinatieri to #-year deal\n***************************\n******document******\ngreg oden was on a path to follow lebron james , a high school prodigy leaping directly to the national basketball association , but he now must wait until #### to seek professional riches .\n******generated summary:*******\ndescends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open\n*******reference summary:*******\nnba hot prospect oden now looks to college first\n***************************\n******document******\npedro astacio did n&#39;t allow a hit until geoff jenkins lined a single to left field with one out in the seventh inning saturday , and the new york mets beat the milwaukee brewers #-# .\n******generated summary:*******\ndescends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open\n*******reference summary:*******\nastacio nearly no-hits brewers as mets win #-#\n***************************\n******document******\nfighting spread saturday through the alleys of densely populated west bank refugee camps , where palestinian militants reportedly were handing out explosives-packed belts to residents willing to strap them on and challenge israeli soldiers .\n******generated summary:*******\nreplacement republican performance thailand descends thailand descends number village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village\n*******reference summary:*******\nfighting spreads through palestinian refugee camps as death toll\n***************************</code></pre>\n<h3 id=\"模型评估\">模型评估</h3>\n<ul>\n<li>模型加载</li>\n<li>损失评估</li>\n<li>指标评估</li>\n</ul>\n<h4 id=\"模型加载-1\">模型加载</h4>\n<div class=\"sourceCode\" id=\"cb39\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb39-1\"><a href=\"#cb39-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>model.load_state_dict(torch.load(<span class=\"st\">&#39;model.pt&#39;</span>))</span></code></pre></div>\n<pre><code>&lt;All keys matched successfully&gt;</code></pre>\n<h4 id=\"损失评估\">损失评估</h4>\n<div class=\"sourceCode\" id=\"cb41\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb41-1\"><a href=\"#cb41-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 评估测试集的损失，输出损失。直接调用之前定义的evaluate函数，输入为测试数据的迭代器。</span></span>\n<span id=\"cb41-2\"><a href=\"#cb41-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>test_loss<span class=\"op\">=</span> evaluate(model,test_iter,criterion)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb42\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb42-1\"><a href=\"#cb42-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"bu\">print</span>(<span class=\"ss\">f&#39;| Test Loss:</span><span class=\"sc\">&#123;</span>test_loss<span class=\"sc\">:.3f&#125;</span><span class=\"ss\"> | Test PPL:</span><span class=\"sc\">&#123;</span>math<span class=\"sc\">.</span>exp(test_loss)<span class=\"sc\">:7.3f&#125;</span><span class=\"ss\"> |&#39;</span>)</span></code></pre></div>\n<pre><code>| Test Loss:0.998 | Test PPL:  2.713 |</code></pre>\n<h4 id=\"指标评估\">指标评估</h4>\n<p>文本自动摘要的指标通常为ROUGE（Recall-Oriented Understudy for Gisting\nEvaluation），在2004年由Chin-Yew Lin提出。 <img src=\"/.top//attachment:e4ae16be-a267-4f86-9401-d4284cb6223d.png\" alt=\"image.png\"></p>\n<ul>\n<li>分母是人工摘要（也就是数据中标注的摘要）中n-gram的个数，分子是人工摘要和机器生成的自动摘要共现（重合）的n-gram的个数。</li>\n<li>可以看出，ROUGE与召回率（recall）的定义很相似。分母也可以是机器生成的摘要，这样就是准确率（precision），同时也可以计算F1指数。</li>\n<li>通常情况下只用召回率，展示1-gram和2-gram的结果ROUGE-1和ROUGE-2。</li>\n<li>除了ROUGE-1和ROUGE-2之外，还可以用人工摘要和机器生成的摘要的最长公共子序列(Longest\nCommon\nSequence)的长度和生成摘要或者标注摘要的长度之间的比例来评估摘要模型</li>\n</ul>\n<figure>\n<img src=\"/.top//attachment:a96e27f2-6e52-47cf-bc06-9b18468f2e27.png\" alt=\"image.png\">\n<figcaption aria-hidden=\"true\">image.png</figcaption>\n</figure>\n<ul>\n<li>第一个公式分母为标注的摘要长度，计算召回率。第二个公式分母为生成的摘要长度，计算准确率。第三个公式求\n<span class=\"math inline\">\\(F_\\beta\\)</span> ， <span class=\"math inline\">\\(\\beta\\)</span> 的值通常大于1。\n和ROUGE-1、ROUGE-2不同的是，ROUGE-L主要关注F指数。</li>\n<li>目前用python计算评估ROUGE指标通常使用pyrouge，但是pyrouge的安装需要预先安装ROUGE工具，较为麻烦，我们这里直接使用rouge工具包进行ROUGE的评估，rouge可以直接使用pip\ninstall\nrouge安装。rouge输入生成的摘要和人工摘要，输出ROUGE-1、ROUGE-2、ROUGE-L的f指数、准确率和召回率。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb44\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb44-1\"><a href=\"#cb44-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">from</span> rouge <span class=\"im\">import</span> Rouge</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb45\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb45-1\"><a href=\"#cb45-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>rouge <span class=\"op\">=</span> Rouge()</span>\n<span id=\"cb45-2\"><a href=\"#cb45-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>scores <span class=\"op\">=</span> rouge.get_scores(generated_summary,sum_sentence_list,avg<span class=\"op\">=</span><span class=\"va\">True</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb46\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb46-1\"><a href=\"#cb46-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"bu\">print</span>(scores)</span></code></pre></div>\n<pre><code>&#123;&#39;rouge-1&#39;: &#123;&#39;f&#39;: 0.0003508771714373667, &#39;p&#39;: 0.0002, &#39;r&#39;: 0.0014285714285714286&#125;, &#39;rouge-2&#39;: &#123;&#39;f&#39;: 0.0, &#39;p&#39;: 0.0, &#39;r&#39;: 0.0&#125;, &#39;rouge-l&#39;: &#123;&#39;f&#39;: 0.0024999999625000004, &#39;p&#39;: 0.005, &#39;r&#39;: 0.0016666666666666666&#125;&#125;</code></pre>\n<h4 id=\"存在如下问题\">存在如下问题</h4>\n<p>目前普遍使用seq2seq解决文本摘要问题，会出现以下问题：</p>\n<p>1.OOV问题</p>\n<p>源文档语料中的词的数量级通常会很大,但是经常使用的词数量则相对比较固定。因此通常会根据词的频率过滤掉一些词做成词表。这样的做法会导致生成摘要时会遇到UNK的词。</p>\n<p>2.摘要的可读性。</p>\n<p>通常使用贪心算法或者beamsearch方法来做decoding。这些方法生成的句子有时候会存在不通顺的问题。</p>\n<p>3.摘要的重复性。</p>\n<p>这个问题出现的频次很高。与2的原因类似，由于一些decoding的方法的自身缺陷，导致模型会在某一段连续timesteps生成重复的词。</p>\n<p>4.长文本摘要生成难度大。</p>\n<p>对于机器翻译来说，NLG的输入和输出的语素长度大致都在一个量级上，因此NLG在其之上的效果较好。但是对摘要来说，源文本的长度与目标文本的长度通常相差很大，此时就需要encoder很好的将文档的信息总结归纳并传递给decoder，decoder需要完全理解并生成句子。可想而知，这是一个很难的事情。</p>\n<p>5.模型的训练目标与最终的评测指标不太一致。</p>\n<p>这里牵扯到两个问题，一个是seq2seq的训练模式中，通常会使用teacher-forcing的方式，即在decoder上，将真实target的输入和模型在前一时刻生成的词一起送到下一个时刻的神经元中计算。但是在inference时，是不会有真实target的，因此存在一个gap；另一个问题就是通常模型训练的目标函数都是交叉熵损失函数。但是摘要的评测却不是以交叉熵来判断的，目前一些榜单通常以ROUGE、BLEU等方式评测，虽然这些评测也不是很完美，但是与交叉熵的评测角度均在较大差异。</p>\n<p>优化思路 可以尝试如何利用深度无监督模型去做生成式摘要任务。</p>\n<p>例如：以自编码器为主体架构，对其进行不同程度的改造，从压缩或者生成两个角度去无监督生成摘要文本，\n同时为了提升效果，也会利用GPT,XLNET等预训练语言模型做finetune。</p>\n<hr>\n<h3 id=\"about-me\">About ME</h3>\n<h5 id=\"读书城南-在未来面前我们都是孩子\">👋 读书城南，🤔\n在未来面前，我们都是孩子～</h5>\n<ul>\n<li>📙\n一个热衷于探索学习新方向、新事物的智能产品经理，闲暇时间喜欢coding💻、画图🎨、音乐🎵、学习ing~</li>\n</ul>\n<h5 id=\"social-media\">👋 Social Media</h5>\n<ul>\n<li><p>🛠️ Blog: <a href=\"http://oceaneyes.top\">http://oceaneyes.top</a></p></li>\n<li><p>⚡ PM导航: <a href=\"https://pmhub.oceangzy.top\">https://pmhub.oceangzy.top</a></p></li>\n<li><p>☘️ CNBLOG: <a href=\"https://www.cnblogs.com/oceaneyes-gzy/\">https://www.cnblogs.com/oceaneyes-gzy/</a></p></li>\n<li><p>🌱 AI PRJ自己部署的一些算法demo: <a href=\"http://ai.oceangzy.top/\">http://ai.oceangzy.top/</a></p></li>\n<li><p>📫 Email: 1450136519@qq.com</p></li>\n<li><p>💬 WeChat: <a href=\"https://oceaneyes.top/img/wechatqrcode.jpg\">OCEANGZY</a></p></li>\n<li><p>💬 公众号: <a href=\"https://oceaneyes.top/img/wechatgzh.jpeg\">UncleJoker-GZY</a></p></li>\n</ul>\n<h5 id=\"加入小组\">👋 加入小组~</h5>\n<p><img src=\"https://oceaneyes.top/img/zhishigroup.jpg\" title=\"加入组织\" alt width=\"240\"></p>\n<h5 id=\"感谢打赏\">👋 感谢打赏~</h5>\n<p><img src=\"https://oceaneyes.top/img/alipay.jpg\" title=\"支付宝打赏\" alt width=\"140\">\n<img src=\"https://oceaneyes.top/img/wechatpay.jpg\" title=\"微信打赏\" alt width=\"140\"></p>\n","more":"<h2 id=\"基于seq2seqattention实现文本摘要\">基于seq2seq+attention实现文本摘要</h2>\n<ul>\n<li><strong>任务描述</strong>:\n自动摘要是指给出一段文本，我们从中提取出要点，然后再形成一个短的概括性的文本</li>\n</ul>\n<figure>\n<img src=\"/.top//attachment:5f1f621e-0619-402f-b2b9-1827c3fb500b.png\" alt=\"image.png\">\n<figcaption aria-hidden=\"true\">image.png</figcaption>\n</figure>\n<p><img src=\"/.top//attachment:7e378fd8-a713-4afa-9f79-a3059af5cd72.png\" alt=\"image.png\">\nhttps://github.com/pytorch/text/releases/tag/v0.9.0-rc5</p>\n<div class=\"sourceCode\" id=\"cb1\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb1-1\"><a href=\"#cb1-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch</span>\n<span id=\"cb1-2\"><a href=\"#cb1-2\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch.nn <span class=\"im\">as</span> nn</span>\n<span id=\"cb1-3\"><a href=\"#cb1-3\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch.optim <span class=\"im\">as</span> optim</span>\n<span id=\"cb1-4\"><a href=\"#cb1-4\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> torch.nn.functional <span class=\"im\">as</span> F</span>\n<span id=\"cb1-5\"><a href=\"#cb1-5\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> spacy</span>\n<span id=\"cb1-6\"><a href=\"#cb1-6\" aria-hidden=\"true\" tabindex=\"-1\"></a> </span>\n<span id=\"cb1-7\"><a href=\"#cb1-7\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">from</span> torchtext.legacy.datasets <span class=\"im\">import</span> Multi30k</span>\n<span id=\"cb1-8\"><a href=\"#cb1-8\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">from</span> torchtext.legacy.data <span class=\"im\">import</span> Field,Iterator,BucketIterator,TabularDataset</span>\n<span id=\"cb1-9\"><a href=\"#cb1-9\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb1-10\"><a href=\"#cb1-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> pandas <span class=\"im\">as</span> pd</span>\n<span id=\"cb1-11\"><a href=\"#cb1-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> numpy <span class=\"im\">as</span> np</span>\n<span id=\"cb1-12\"><a href=\"#cb1-12\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb1-13\"><a href=\"#cb1-13\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> random</span>\n<span id=\"cb1-14\"><a href=\"#cb1-14\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> math</span>\n<span id=\"cb1-15\"><a href=\"#cb1-15\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">import</span> time</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb2\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb2-1\"><a href=\"#cb2-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 全局初始化配置参数。 固定随机种子， 使得每次运行的结果相同</span></span>\n<span id=\"cb2-2\"><a href=\"#cb2-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>SEED <span class=\"op\">=</span> <span class=\"dv\">22</span></span>\n<span id=\"cb2-3\"><a href=\"#cb2-3\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb2-4\"><a href=\"#cb2-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>random.seed(SEED)</span>\n<span id=\"cb2-5\"><a href=\"#cb2-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>np.random.seed(SEED)</span>\n<span id=\"cb2-6\"><a href=\"#cb2-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>torch.manual_seed(SEED)</span>\n<span id=\"cb2-7\"><a href=\"#cb2-7\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb2-8\"><a href=\"#cb2-8\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">if</span> torch.cuda.is_available():</span>\n<span id=\"cb2-9\"><a href=\"#cb2-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>    torch.cuda.manual_seed_all(SEED)</span>\n<span id=\"cb2-10\"><a href=\"#cb2-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    torch.backends.cudnn.deterministic <span class=\"op\">=</span> <span class=\"va\">True</span></span></code></pre></div>\n<h2 id=\"数据准备\">数据准备</h2>\n<ul>\n<li>数据整理</li>\n<li>数据说明</li>\n<li>数据预处理</li>\n</ul>\n<h3 id=\"数据整理\">数据整理</h3>\n<div class=\"sourceCode\" id=\"cb3\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb3-1\"><a href=\"#cb3-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_train_path <span class=\"op\">=</span> <span class=\"st\">&quot;./dataset/train.csv&quot;</span></span>\n<span id=\"cb3-2\"><a href=\"#cb3-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_test_path <span class=\"op\">=</span> <span class=\"st\">&quot;./dataset/test.csv&quot;</span></span>\n<span id=\"cb3-3\"><a href=\"#cb3-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_val_path <span class=\"op\">=</span> <span class=\"st\">&quot;./dataset/val.csv&quot;</span></span></code></pre></div>\n<h3 id=\"数据说明\">数据说明</h3>\n<div class=\"sourceCode\" id=\"cb4\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb4-1\"><a href=\"#cb4-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_train <span class=\"op\">=</span> pd.read_csv(data_train_path,encoding<span class=\"op\">=</span><span class=\"st\">&quot;utf-8&quot;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb5\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb5-1\"><a href=\"#cb5-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_train.head()</span></code></pre></div>\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n    \n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n<thead>\n<tr style=\"text-align: right;\">\n<th>\n</th>\n<th>\ndocument\n</th>\n<th>\nsummary\n</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<th>\n0\n</th>\n<td>\njason blake of the islanders will miss the res...\n</td>\n<td>\nblake missing rest of season\n</td>\n</tr>\n<tr>\n<th>\n1\n</th>\n<td>\nthe u.s. military on wednesday captured a wife...\n</td>\n<td>\nu.s. arrests wife and daughter of saddam deput...\n</td>\n</tr>\n<tr>\n<th>\n2\n</th>\n<td>\ncraig bellamy 's future at west ham appeared i...\n</td>\n<td>\nwest ham drops bellamy amid transfer turmoil\n</td>\n</tr>\n<tr>\n<th>\n3\n</th>\n<td>\ncambridge - when barack obama sought advice be...\n</td>\n<td>\nin search for expertise harvard looms large\n</td>\n</tr>\n<tr>\n<th>\n4\n</th>\n<td>\nwall street held on to steep gains on monday ,...\n</td>\n<td>\nwall street ends a three-day losing streak\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<h3 id=\"数据预处理\">数据预处理</h3>\n<ul>\n<li>构建分词函数</li>\n<li>构建预处理格式</li>\n<li>载入数据</li>\n<li>构建数据迭代器</li>\n<li>构建词表</li>\n</ul>\n<h4 id=\"构建分词函数\">构建分词函数</h4>\n<div class=\"sourceCode\" id=\"cb6\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb6-1\"><a href=\"#cb6-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 加载spacy的英文处理包</span></span>\n<span id=\"cb6-2\"><a href=\"#cb6-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>spacy_en <span class=\"op\">=</span> spacy.load(<span class=\"st\">&#39;en_core_web_sm&#39;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb7\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb7-1\"><a href=\"#cb7-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 构建分词函数， 返回文本里包含的所有词组的列表</span></span>\n<span id=\"cb7-2\"><a href=\"#cb7-2\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> tokenize(text):</span>\n<span id=\"cb7-3\"><a href=\"#cb7-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> [tok.text <span class=\"cf\">for</span> tok <span class=\"kw\">in</span> spacy_en.tokenizer(text)]</span></code></pre></div>\n<h4 id=\"构建预处理格式\">构建预处理格式</h4>\n<h5 id=\"torchtext的field函数可以构建预处理格式\">torchtext的Field函数可以构建预处理格式</h5>\n<ul>\n<li>sequential：代表是否需要将数据序列化，大多数自然语言处理任务都是序列计算</li>\n<li>tokenize：需要传入分词函数，传入之前定义的tokenize函数</li>\n<li>lower：代表是否转换成小写，为了统一处理，把所有的字符转换成小写</li>\n<li>include_lengths：代表是否返回序列的长度，在gpu计算中，通常是对矩阵的运算，因此每个batch中，矩阵的长度为该batch中所有数据里最长的长度，其他长度不够的数据通常用pad字符补齐，这就会导致矩阵中有很多pad字符。为了后续的计算中把这些pad字符规避掉，我们需要返回每个数据的真实长度，这里的长度是指分词后每个文本中词组的数量</li>\n<li>init_token：传入起始符号，自然语言处理的任务中通常需要在文本的开头加入起始符号，作为句子的开始标记</li>\n<li>eos_token：传入结束符号，自然语言处理的任务中通常需要在文本的加入结束符号，作为句子的结束标记</li>\n<li>pad_token：传入pad符号，用来补全长度不够的文本，默认为\n&lt;pad&gt;</li>\n<li>unk_token：传入unk符号，默认为\n&lt;unk&gt;。自然语言处理任务中，往往有一些词组不在我们构建的词表中，这种现场叫做00V（Out\nOf Vocabulary），用一个unk字符来表示这些字符。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb8\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb8-1\"><a href=\"#cb8-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOCUMENT <span class=\"op\">=</span> Field(sequential<span class=\"op\">=</span><span class=\"va\">True</span>, </span>\n<span id=\"cb8-2\"><a href=\"#cb8-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>                tokenize<span class=\"op\">=</span>tokenize,</span>\n<span id=\"cb8-3\"><a href=\"#cb8-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>                lower<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb8-4\"><a href=\"#cb8-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>                include_lengths<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb8-5\"><a href=\"#cb8-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>               init_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;sos&gt;&#39;</span>,</span>\n<span id=\"cb8-6\"><a href=\"#cb8-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>               eos_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;eos&gt;&#39;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb9\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb9-1\"><a href=\"#cb9-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>SUMMARY <span class=\"op\">=</span> Field(sequential<span class=\"op\">=</span><span class=\"va\">True</span>, </span>\n<span id=\"cb9-2\"><a href=\"#cb9-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>                tokenize<span class=\"op\">=</span>tokenize,</span>\n<span id=\"cb9-3\"><a href=\"#cb9-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>                lower<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb9-4\"><a href=\"#cb9-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>                include_lengths<span class=\"op\">=</span><span class=\"va\">True</span>,</span>\n<span id=\"cb9-5\"><a href=\"#cb9-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>               init_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;sos&gt;&#39;</span>,</span>\n<span id=\"cb9-6\"><a href=\"#cb9-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>               eos_token<span class=\"op\">=</span><span class=\"st\">&#39;&lt;eos&gt;&#39;</span>)</span></code></pre></div>\n<h4 id=\"载入数据\">载入数据</h4>\n<div class=\"sourceCode\" id=\"cb10\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb10-1\"><a href=\"#cb10-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>fields <span class=\"op\">=</span> [(<span class=\"st\">&quot;document&quot;</span>,DOCUMENT),(<span class=\"st\">&quot;summary&quot;</span>,SUMMARY)]</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb11\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb11-1\"><a href=\"#cb11-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>train <span class=\"op\">=</span> TabularDataset(path<span class=\"op\">=</span>data_train_path, <span class=\"bu\">format</span><span class=\"op\">=</span><span class=\"st\">&quot;csv&quot;</span>, fields<span class=\"op\">=</span>fields, skip_header<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb11-2\"><a href=\"#cb11-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>val <span class=\"op\">=</span> TabularDataset(path<span class=\"op\">=</span>data_val_path, <span class=\"bu\">format</span><span class=\"op\">=</span><span class=\"st\">&quot;csv&quot;</span>, fields<span class=\"op\">=</span>fields, skip_header<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb11-3\"><a href=\"#cb11-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>test <span class=\"op\">=</span> TabularDataset(path<span class=\"op\">=</span>data_test_path, <span class=\"bu\">format</span><span class=\"op\">=</span><span class=\"st\">&quot;csv&quot;</span>, fields<span class=\"op\">=</span>fields, skip_header<span class=\"op\">=</span><span class=\"va\">True</span>)</span></code></pre></div>\n<h4 id=\"构建数据迭代器\">构建数据迭代器</h4>\n<h5 id=\"bucketiterator会自动将长度类似的文本归在一个batch这样可以减少补全字符pad的数量易于计算\">BucketIterator会自动将长度类似的文本归在一个batch，这样可以减少补全字符pad的数量，易于计算</h5>\n<ul>\n<li>train：传入之前用TabularDataset载入的数据</li>\n<li>batch_size：传入每个批次包含的数据数量</li>\n<li>device：代表传入数据的设备，可以选择gpu或者cpu</li>\n<li>sort_within_batch：代表是否对一个批次内的数据排序</li>\n<li>sort_key：排序方式，由于要使用到pack_padded_sequence用来规避pad符号，而pack_padded_sequence需要数据以降序的形式排列，所以这里用document的长度进行降序。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb12\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb12-1\"><a href=\"#cb12-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>device <span class=\"op\">=</span> torch.device(<span class=\"st\">&#39;cuda&#39;</span> <span class=\"cf\">if</span> torch.cuda.is_available() <span class=\"cf\">else</span> <span class=\"st\">&#39;cpu&#39;</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb13\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb13-1\"><a href=\"#cb13-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>device</span></code></pre></div>\n<pre><code>device(type=&#39;cpu&#39;)</code></pre>\n<div class=\"sourceCode\" id=\"cb15\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb15-1\"><a href=\"#cb15-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>BATCH_SIZE <span class=\"op\">=</span> <span class=\"dv\">100</span> <span class=\"op\">//</span> <span class=\"dv\">20</span></span>\n<span id=\"cb15-2\"><a href=\"#cb15-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>train_iter <span class=\"op\">=</span> BucketIterator(train, batch_size<span class=\"op\">=</span>BATCH_SIZE, device<span class=\"op\">=</span>device, sort_key <span class=\"op\">=</span> <span class=\"kw\">lambda</span> x :<span class=\"bu\">len</span>(x.document), sort_within_batch<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb15-3\"><a href=\"#cb15-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>val_iter <span class=\"op\">=</span> BucketIterator(val,batch_size<span class=\"op\">=</span>BATCH_SIZE, device<span class=\"op\">=</span>device, sort_key <span class=\"op\">=</span> <span class=\"kw\">lambda</span> x:<span class=\"bu\">len</span>(x.document), sort_within_batch<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb15-4\"><a href=\"#cb15-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>test_iter <span class=\"op\">=</span> BucketIterator(test,batch_size<span class=\"op\">=</span>BATCH_SIZE, device<span class=\"op\">=</span>device, sort_key <span class=\"op\">=</span> <span class=\"kw\">lambda</span> x:<span class=\"bu\">len</span>(x.document), sort_within_batch<span class=\"op\">=</span><span class=\"va\">True</span>)</span></code></pre></div>\n<h4 id=\"构建词表\">构建词表</h4>\n<p>往往将字符转换成数字，需要构建词表，用以用数字表示每个词组，并用来训练embedding。\n- 在训练集上构建词表，频次低于min_freq的词组会被过滤。 -\n构建完词表后会自动将迭代器数据中的字符转换成单词在词表中的序号。</p>\n<p>在这里，我们对document和summary分别单独构建了词表，也可以只构建一个词表，使document和summary共享词表。</p>\n<div class=\"sourceCode\" id=\"cb16\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb16-1\"><a href=\"#cb16-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOCUMENT.build_vocab(train,min_freq<span class=\"op\">=</span> <span class=\"dv\">2</span>)</span>\n<span id=\"cb16-2\"><a href=\"#cb16-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>SUMMARY.build_vocab(train,min_freq<span class=\"op\">=</span><span class=\"dv\">2</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb17\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb17-1\"><a href=\"#cb17-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOCUMENT.vocab.itos[:<span class=\"dv\">100</span>]</span></code></pre></div>\n<pre><code>[&#39;&lt;unk&gt;&#39;,\n &#39;&lt;pad&gt;&#39;,\n &#39;&lt;sos&gt;&#39;,\n &#39;&lt;eos&gt;&#39;,\n &#39;the&#39;,\n &#39;#&#39;,\n &#39;.&#39;,\n &#39;,&#39;,\n &#39;a&#39;,\n &#39;of&#39;,\n &#39;to&#39;,\n &#39;in&#39;,\n &#39;and&#39;,\n &#39;on&#39;,\n &quot;&#39;s&quot;,\n &#39;-&#39;,\n &#39;for&#39;,\n &#39;said&#39;,\n &#39;that&#39;,\n &#39;with&#39;,\n &#39;at&#39;,\n &#39;an&#39;,\n &#39;`&#39;,\n &#39;as&#39;,\n &#39;by&#39;,\n &#39;from&#39;,\n &#39;has&#39;,\n &#39;his&#39;,\n &#39;tuesday&#39;,\n &#39;wednesday&#39;,\n &#39;thursday&#39;,\n &#39;its&#39;,\n &#39;monday&#39;,\n &#39;was&#39;,\n &#39;&lt;&#39;,\n &#39;&gt;&#39;,\n &#39;unk&#39;,\n &#39;is&#39;,\n &#39;friday&#39;,\n &#39;president&#39;,\n &#39;-lrb-&#39;,\n &#39;-rrb-&#39;,\n &#39;after&#39;,\n &#39;new&#39;,\n &#39;will&#39;,\n &#39;it&#39;,\n &#39;two&#39;,\n &#39;government&#39;,\n &#39;their&#39;,\n &#39;have&#39;,\n &#39;u.s&#39;,\n &#39;over&#39;,\n &quot;&#39;&#39;&quot;,\n &#39;minister&#39;,\n &#39;year&#39;,\n &#39;china&#39;,\n &#39;world&#39;,\n &#39;first&#39;,\n &#39;sunday&#39;,\n &#39;he&#39;,\n &#39;who&#39;,\n &#39;saturday&#39;,\n &#39;be&#39;,\n &#39;here&#39;,\n &#39;were&#39;,\n &#39;against&#39;,\n &#39;this&#39;,\n &#39;people&#39;,\n &#39;officials&#39;,\n &#39;up&#39;,\n &#39;are&#39;,\n &#39;more&#39;,\n &#39;country&#39;,\n &#39;us&#39;,\n &#39;united&#39;,\n &#39;police&#39;,\n &#39;percent&#39;,\n &#39;one&#39;,\n &#39;state&#39;,\n &#39;reported&#39;,\n &#39;into&#39;,\n &#39;million&#39;,\n &#39;last&#39;,\n &#39;three&#39;,\n &#39;official&#39;,\n &#39;been&#39;,\n &#39;than&#39;,\n &#39;had&#39;,\n &#39;not&#39;,\n &#39;would&#39;,\n &#39;but&#39;,\n &#39;years&#39;,\n &#39;about&#39;,\n &#39;former&#39;,\n &#39;prime&#39;,\n &#39;states&#39;,\n &#39;they&#39;,\n &#39;international&#39;,\n &#39;day&#39;,\n &#39;week&#39;]</code></pre>\n<h3 id=\"模型\">模型</h3>\n<ul>\n<li>模型概述</li>\n<li>模型结构定义</li>\n<li>模型实例化</li>\n<li>查看模型</li>\n</ul>\n<h4 id=\"模型该书\">模型该书</h4>\n<ul>\n<li><p>seq2seq是一个Encoder–Decoder结构的网络，它的输入是一个序列，输出也是一个序列，seq2seq最早应用在翻译模型中，输入原文，输出为翻译后的译文。</p></li>\n<li><p>attention机制的用途是建立生成的译文中的每个单词和原文每个单词的联系，通过这种依赖关系，生成更精准的译文，seq2seq的结构如下图所示：\n<img src=\"/.top//attachment:7a9c3e26-c015-4bf8-b2dd-96f082617b03.png\" alt=\"image.png\"></p>\n<ul>\n<li>左边为Encoder，是由rnn组成，顺序输入原文中单词的embedding，对于每个位置都输出一个hidden\nstate <span class=\"math inline\">\\(h_i\\)</span>\n作为这个状态的表示，这个状态包含了之前所有单词的信息，待序列中所有的单词计算完后，Encoder输出一个变量\n<span class=\"math inline\">\\(h\\)</span>\n作为整个序列的表示，这个变量可以直接是最后一个状态的表示，也可以对所有状态进行融合，将它们变换成一个固定维度的矩阵。</li>\n<li>右边是Decoder，它第一个状态的输入为Encoder的输出 <span class=\"math inline\">\\(h\\)</span> 和 [单词的embedding;\nattention]，方括号内表示两个变量的连接，输出为 <span class=\"math inline\">\\(s_j\\)</span> ，用[s_j; attention;\nembedding]预测这一步生成的单词，这里为了图像整体的简洁，没有画出attention对后面的状态的连接，实际上每一步生成都要连接attention。</li>\n<li>Decoder和Encoder之间有一个attention，在最早的seq2seq模型中是没有attention的，Decoder直接接收Encoder的输出\n<span class=\"math inline\">\\(h\\)</span>\n，这在生成译文单词的前期效果不错，但是随着生成单词的增多，rnn会逐渐遗忘掉\n<span class=\"math inline\">\\(h\\)</span>\n的信息，这会导致生成的单词不够精准，而且无法建立原文和译文每个单词对应的关系，而attention由于在生成的每一步都会引入到生产过程中，并且每一步都计算Decoder的状态和Encoder每个状态的相似度用来建立关系，不仅使得生成效果更好，而且具有更强的可解释性，在很多翻译实验中，会把attention保存起来，建立一个attention的词表来观测不同语种单词之间的对应关系。</li>\n</ul></li>\n</ul>\n<h4 id=\"模型结构定义\">模型结构定义</h4>\n<h5 id=\"encoder\">Encoder</h5>\n<figure>\n<img src=\"/.top//attachment:83f35c9b-6e96-448a-8b04-e70de555a8e4.png\" alt=\"image.png\">\n<figcaption aria-hidden=\"true\">image.png</figcaption>\n</figure>\n<h5 id=\"decoder\">Decoder</h5>\n<ul>\n<li><p>这里为了获得上下文的语义表示，用了双向RNN，包含从sos向eos的前向RNN和从eos向sos的后向RNN，每个状态的表示变为前向RNN的输出和后向RNN的输出的连接\n<span class=\"math inline\">\\([\\vec{h_i}; \\mathop{h_i} \\limits\n^{\\leftarrow}]\\)</span>，这样每个状态都包含了来自前文和后文的语义信息。</p></li>\n<li><p>Encoder的内部由RNN组成，RNN的形式为： <span class=\"math inline\">\\(h_i = RNN(h_{i-1},e(x_i))\\)</span></p></li>\n<li><p>输入为前一个状态表示和这一步的单词的embedding。 <span class=\"math inline\">\\(h_0\\)</span>\n为一个全0矩阵，这里的RNN也可以替换成LSTM或者GRU。待所有的单词输入完毕后，Encoder会计算一个序列整体的表示，这里将前向RNN的最终输出和后向RNN输出的连接\n<span class=\"math inline\">\\([\\vec{h}; \\mathop{h} \\limits\n^{\\leftarrow}]\\)</span>\n传入到一个全连接层进行变换，转换成Decoder输出的大小： <span class=\"math inline\">\\(hidden = tanh(w[\\vec{h}; \\mathop{h} \\limits\n^{\\leftarrow}] + b )\\)</span></p></li>\n<li><p>Encoder函数构建一个encoder，内部RNN使用了torch内置的GRU，参数为：</p>\n<ul>\n<li>input_dim：输入词表的大小</li>\n<li>emb_dim：embedding的维度</li>\n<li>enc_hid_dim：隐藏层的大小</li>\n<li>dropout：dropout的概率</li>\n</ul></li>\n<li><p>forward参数：</p>\n<ul>\n<li>doc：原文数据，是已经由词通过词表转换成序号的数据</li>\n<li>doc_len：每个数据的真实长度，在计算RNN时，可以只计算相应长度的状态，不计算pad符号</li>\n</ul></li>\n<li><p>forword输出Encoder整体的输出，以及Encoder每个状态的输出。每个状态的输出用来计算后续的attention。</p></li>\n<li><p>值得注意的是，为了规避掉后续计算attention时受到序列中存在pad符号的影响，这里应用了nn.utils的pad_paddad_sequence方法，可以去掉doc_len以后的pad符号，这里pad_packed_sequence的输入为单词序列的embedding和序列的真实长度，这样在计算序列时，就不会计算doc_len后的pad符号了。在计算完RNN后，为了形成一个矩阵方便GPU计算，会把每个doc_len\n&lt; max_len\n的序列填充起来，这里使用了pad_packed_sequence方法，输入为RNN计算后的序列packed_outputs，在后续的attention计算时，会把填充的信息规避掉。</p></li>\n</ul>\n<div class=\"sourceCode\" id=\"cb19\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb19-1\"><a href=\"#cb19-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># encoder的输入为原文， 输出为hidden_state, size需设置</span></span>\n<span id=\"cb19-2\"><a href=\"#cb19-2\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Encoder(nn.Module):</span>\n<span id=\"cb19-3\"><a href=\"#cb19-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,input_dim,emb_dim,enc_hid_dim, dec_hid_dim,dropout):</span>\n<span id=\"cb19-4\"><a href=\"#cb19-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb19-5\"><a href=\"#cb19-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb19-6\"><a href=\"#cb19-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义embedding层， 直接使用 torch.nn.Embedding函数</span></span>\n<span id=\"cb19-7\"><a href=\"#cb19-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.embedding <span class=\"op\">=</span> nn.Embedding(input_dim,emb_dim)</span>\n<span id=\"cb19-8\"><a href=\"#cb19-8\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb19-9\"><a href=\"#cb19-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义rnn层， 使用torch.nn.GRU</span></span>\n<span id=\"cb19-10\"><a href=\"#cb19-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.rnn <span class=\"op\">=</span> nn.GRU(emb_dim,enc_hid_dim,bidirectional<span class=\"op\">=</span><span class=\"va\">True</span>)</span>\n<span id=\"cb19-11\"><a href=\"#cb19-11\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb19-12\"><a href=\"#cb19-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义一个 全连接层， 用来 将encoder的输出转换成 decoder输入的大小</span></span>\n<span id=\"cb19-13\"><a href=\"#cb19-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.fc <span class=\"op\">=</span> nn.Linear(enc_hid_dim <span class=\"op\">*</span> <span class=\"dv\">2</span> ,dec_hid_dim)</span>\n<span id=\"cb19-14\"><a href=\"#cb19-14\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb19-15\"><a href=\"#cb19-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义dropout层， 防止过拟合</span></span>\n<span id=\"cb19-16\"><a href=\"#cb19-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.dropout <span class=\"op\">=</span> nn.Dropout(dropout)</span>\n<span id=\"cb19-17\"><a href=\"#cb19-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-18\"><a href=\"#cb19-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,doc,doc_len):</span>\n<span id=\"cb19-19\"><a href=\"#cb19-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        embedded <span class=\"op\">=</span> <span class=\"va\">self</span>.dropout(<span class=\"va\">self</span>.embedding(doc))</span>\n<span id=\"cb19-20\"><a href=\"#cb19-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-21\"><a href=\"#cb19-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        packed_embedded <span class=\"op\">=</span> nn.utils.rnn.pack_padded_sequence(embedded,doc_len)</span>\n<span id=\"cb19-22\"><a href=\"#cb19-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-23\"><a href=\"#cb19-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># packed_outputs 包含了每个RNN中每个状态的输出，如图中的h1,h2,h3...hn</span></span>\n<span id=\"cb19-24\"><a href=\"#cb19-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># hidden只有最后的输出hn</span></span>\n<span id=\"cb19-25\"><a href=\"#cb19-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        packed_outputs, hidden <span class=\"op\">=</span> <span class=\"va\">self</span>.rnn(packed_embedded)</span>\n<span id=\"cb19-26\"><a href=\"#cb19-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-27\"><a href=\"#cb19-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        outputs, _ <span class=\"op\">=</span> nn.utils.rnn.pad_packed_sequence(packed_outputs)</span>\n<span id=\"cb19-28\"><a href=\"#cb19-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-29\"><a href=\"#cb19-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        hidden <span class=\"op\">=</span> torch.tanh(<span class=\"va\">self</span>.fc(torch.cat((hidden[<span class=\"op\">-</span><span class=\"dv\">2</span>,:,:], hidden[<span class=\"op\">-</span><span class=\"dv\">1</span>,:,:]),dim<span class=\"op\">=</span><span class=\"dv\">1</span>)))</span>\n<span id=\"cb19-30\"><a href=\"#cb19-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb19-31\"><a href=\"#cb19-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> outputs,hidden</span></code></pre></div>\n<h5 id=\"attention\">attention</h5>\n<ul>\n<li><p>attention机制可以建立Decoder的状态 <span class=\"math inline\">\\(s_i\\)</span> 和Encoder每个状态 <span class=\"math inline\">\\(h_j\\)</span> 的关系，如下图所示： <img src=\"/.top//attachment:08055b25-8707-449b-8782-1cf18c9eaf3b.png\" alt=\"image.png\"> 这里计算 <span class=\"math inline\">\\(s_2\\)</span> 和\nEncoder中每个状态的关系，需要用到 <span class=\"math inline\">\\(s_1\\)</span> 的信息，先计算Decoder中 <span class=\"math inline\">\\(s_{i-1}\\)</span> 和 Encodr状态 <span class=\"math inline\">\\(h_{j}\\)</span> 的相似度： <span class=\"math inline\">\\(e_{ij} = a(s_{i-1}, hj)\\)</span> 将 <span class=\"math inline\">\\([s_{i-1};h_{j}]\\)</span>\n传入至一个全连接层计算相似度。 然后将<span class=\"math inline\">\\(s_{i-1}\\)</span> 和\nEncoder中每个状态的相似度做一个softmax变化，得到每个Encoder中每个状态所占的权重，作为attention：\n<span class=\"math inline\">\\(\\alpha_{ij} = \\frac{exp(e_{ij})}{\\sum^{T}_{k\n= 1}(exp(e_{ik}))}\\)</span> attention中的每个权重会用来计算context\nvector，即上下文的向量： <span class=\"math inline\">\\(c_i = \\sum_{k =\n1}^{T} \\alpha_{ij} h_j\\)</span> 这个context\nvector会在Decoder中作为一部分输入。</p></li>\n<li><p>构建Attention类，参数：</p>\n<ul>\n<li>enc_hid_dim：encoder每个位置输出的维度</li>\n<li>dec_hid_dim：decoder每个位置输出的维度</li>\n</ul></li>\n<li><p>forward的参数：</p>\n<ul>\n<li>hidden：decoder里rnn前一个状态的输出</li>\n<li>encoder_outs：encoder里rnn的输出</li>\n<li>mask：mask矩阵，里面存储的是0-1矩阵，0代表被规避的pad符号的位置</li>\n</ul></li>\n<li><p>forword的输出为attention中的每个权重，context\nvector的计算在下面的Decoder类</p></li>\n</ul>\n<div class=\"sourceCode\" id=\"cb20\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb20-1\"><a href=\"#cb20-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Attention(nn.Module):</span>\n<span id=\"cb20-2\"><a href=\"#cb20-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,enc_hid_dim,dec_hid_dim):</span>\n<span id=\"cb20-3\"><a href=\"#cb20-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb20-4\"><a href=\"#cb20-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.attn <span class=\"op\">=</span> nn.Linear((enc_hid_dim <span class=\"op\">*</span> <span class=\"dv\">2</span>) <span class=\"op\">+</span> dec_hid_dim, dec_hid_dim)</span>\n<span id=\"cb20-5\"><a href=\"#cb20-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.v <span class=\"op\">=</span> nn.Linear(dec_hid_dim, <span class=\"dv\">1</span>, bias<span class=\"op\">=</span> <span class=\"va\">False</span>)</span>\n<span id=\"cb20-6\"><a href=\"#cb20-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-7\"><a href=\"#cb20-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,hidden, encoder_outputs, mask):</span>\n<span id=\"cb20-8\"><a href=\"#cb20-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        batch_size <span class=\"op\">=</span> encoder_outputs.shape[<span class=\"dv\">1</span>]</span>\n<span id=\"cb20-9\"><a href=\"#cb20-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        doc_len <span class=\"op\">=</span> encoder_outputs.shape[<span class=\"dv\">0</span>]</span>\n<span id=\"cb20-10\"><a href=\"#cb20-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-11\"><a href=\"#cb20-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 对decoder的状态重复doc_len次，用来计算和每个encoder状态的相似度</span></span>\n<span id=\"cb20-12\"><a href=\"#cb20-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        hidden <span class=\"op\">=</span> hidden.unsqueeze(<span class=\"dv\">1</span>).repeat(<span class=\"dv\">1</span>,doc_len,<span class=\"dv\">1</span>)</span>\n<span id=\"cb20-13\"><a href=\"#cb20-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-14\"><a href=\"#cb20-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs <span class=\"op\">=</span> encoder_outputs.permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>,<span class=\"dv\">2</span>)</span>\n<span id=\"cb20-15\"><a href=\"#cb20-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 使用全连接层计算相似度</span></span>\n<span id=\"cb20-16\"><a href=\"#cb20-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        energy <span class=\"op\">=</span> torch.tanh(<span class=\"va\">self</span>.attn(torch.cat((hidden,encoder_outputs), dim<span class=\"op\">=</span><span class=\"dv\">2</span>)))</span>\n<span id=\"cb20-17\"><a href=\"#cb20-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-18\"><a href=\"#cb20-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 转换尺寸 [batch, doc_len]的形式作为 和每个encoder状态的相似度</span></span>\n<span id=\"cb20-19\"><a href=\"#cb20-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        attention <span class=\"op\">=</span> <span class=\"va\">self</span>.v(energy).squeeze(<span class=\"dv\">2</span>)</span>\n<span id=\"cb20-20\"><a href=\"#cb20-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-21\"><a href=\"#cb20-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 规避encoder里的 pad符号， 将这些位置的权重值降到最低</span></span>\n<span id=\"cb20-22\"><a href=\"#cb20-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        attention <span class=\"op\">=</span> attention.masked_fill(mask <span class=\"op\">==</span><span class=\"dv\">0</span>, <span class=\"op\">-</span><span class=\"fl\">1e10</span>)</span>\n<span id=\"cb20-23\"><a href=\"#cb20-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb20-24\"><a href=\"#cb20-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 返回权重</span></span>\n<span id=\"cb20-25\"><a href=\"#cb20-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> F.softmax(attention,dim<span class=\"op\">=</span><span class=\"dv\">1</span>)</span></code></pre></div>\n<h4 id=\"decoder-1\">decoder</h4>\n<ul>\n<li>Decoder接收之前的状态信息、输入的单词和context\nvector，预测生成摘要的单词，结构如下所示： <img src=\"/.top//attachment:6a34d1b0-6c17-4fe1-9d24-e521610d0f76.png\" alt=\"image.png\"></li>\n<li>Decoder的RNN与Encoder中的RNN有所不同，输入为[前一步生成单词的embedding;context\nvector]和前一步的状态 hi−1hi−1h_{i-1}，</li>\n<li>目的是引入attention的信息：si=RNN([e(yi−1);c],si−1)si=RNN([e(yi−1);c],si−1)s_i\n= RNN([e(y_{i-1});c],s_{i-1})</li>\n<li>在预测生成的单词时，将context vector、\nRNN的输出状态、前一步生成单词的embedding连接起来输入至全连接层预测：yi=softmax(w[c;si;e(yi−1)]+b)yi=softmax(w[c;si;e(yi−1)]+b)y_i\n= softmax(w[c;s_i;e(y_{i-1})] + b)</li>\n<li>构建Decoder类，参数为：\n<ul>\n<li>output_dim：输出的维度，为词表的长度</li>\n<li>emb_dim：embedding的维度</li>\n<li>enc_hid_dim：encoder每个位置输出的维度</li>\n<li>dec_hid_dim：decoder每个位置输出的维度</li>\n<li>dropout：dropout的概率</li>\n<li>attention：需要传入attention类，用来计算decoder每个位置的输出和encoder每个位置的输出的关系</li>\n</ul></li>\n<li>forword参数：\n<ul>\n<li>input：输入单词的序号</li>\n<li>hidden：上一步Decoder输出的状态</li>\n<li>encoder_outputs：Encoder每个状态的输出，用来计算attention</li>\n<li>mask：mask矩阵，用来在计算attention时，规避pad符号的影响</li>\n</ul></li>\n<li>forword输出为全连接层的输出、这一步Decoder的输出和attention的权重。这里输出的是预测时全连接层的输出，目的是计算后续的损失。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb21\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb21-1\"><a href=\"#cb21-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Decoder(nn.Module):</span>\n<span id=\"cb21-2\"><a href=\"#cb21-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,output_dim,emb_dim,enc_hid_dim,dec_hid_dim,dropout, attention):</span>\n<span id=\"cb21-3\"><a href=\"#cb21-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb21-4\"><a href=\"#cb21-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.output_dim <span class=\"op\">=</span> output_dim</span>\n<span id=\"cb21-5\"><a href=\"#cb21-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.attention <span class=\"op\">=</span> attention</span>\n<span id=\"cb21-6\"><a href=\"#cb21-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-7\"><a href=\"#cb21-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.embedding <span class=\"op\">=</span> nn.Embedding(output_dim,emb_dim)</span>\n<span id=\"cb21-8\"><a href=\"#cb21-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-9\"><a href=\"#cb21-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.rnn <span class=\"op\">=</span> nn.GRU((enc_hid_dim <span class=\"op\">*</span><span class=\"dv\">2</span> )<span class=\"op\">+</span> emb_dim, dec_hid_dim)</span>\n<span id=\"cb21-10\"><a href=\"#cb21-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-11\"><a href=\"#cb21-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.fc_out <span class=\"op\">=</span> nn.Linear((enc_hid_dim <span class=\"op\">*</span> <span class=\"dv\">2</span>)<span class=\"op\">+</span> dec_hid_dim <span class=\"op\">+</span> emb_dim , output_dim)</span>\n<span id=\"cb21-12\"><a href=\"#cb21-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-13\"><a href=\"#cb21-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.dropout <span class=\"op\">=</span> nn.Dropout(dropout)</span>\n<span id=\"cb21-14\"><a href=\"#cb21-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-15\"><a href=\"#cb21-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,<span class=\"bu\">input</span>,hidden,encoder_outputs,mask):</span>\n<span id=\"cb21-16\"><a href=\"#cb21-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">input</span> <span class=\"op\">=</span> <span class=\"bu\">input</span>.unsqueeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-17\"><a href=\"#cb21-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-18\"><a href=\"#cb21-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>        embedded <span class=\"op\">=</span> <span class=\"va\">self</span>.dropout(<span class=\"va\">self</span>.embedding(<span class=\"bu\">input</span>))</span>\n<span id=\"cb21-19\"><a href=\"#cb21-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-20\"><a href=\"#cb21-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        a <span class=\"op\">=</span> <span class=\"va\">self</span>.attention(hidden,encoder_outputs,mask)</span>\n<span id=\"cb21-21\"><a href=\"#cb21-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-22\"><a href=\"#cb21-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        a <span class=\"op\">=</span> a.unsqueeze(<span class=\"dv\">1</span>)</span>\n<span id=\"cb21-23\"><a href=\"#cb21-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-24\"><a href=\"#cb21-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs <span class=\"op\">=</span> encoder_outputs.permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>,<span class=\"dv\">2</span>)</span>\n<span id=\"cb21-25\"><a href=\"#cb21-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-26\"><a href=\"#cb21-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        weighted <span class=\"op\">=</span> torch.bmm(a,encoder_outputs)</span>\n<span id=\"cb21-27\"><a href=\"#cb21-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-28\"><a href=\"#cb21-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        weighted <span class=\"op\">=</span> weighted.permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>,<span class=\"dv\">2</span>)</span>\n<span id=\"cb21-29\"><a href=\"#cb21-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-30\"><a href=\"#cb21-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        rnn_input <span class=\"op\">=</span> torch.cat((embedded, weighted), dim<span class=\"op\">=</span><span class=\"dv\">2</span>)</span>\n<span id=\"cb21-31\"><a href=\"#cb21-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-32\"><a href=\"#cb21-32\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output,hidden <span class=\"op\">=</span> <span class=\"va\">self</span>.rnn(rnn_input, hidden.unsqueeze(<span class=\"dv\">0</span>))</span>\n<span id=\"cb21-33\"><a href=\"#cb21-33\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-34\"><a href=\"#cb21-34\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">assert</span> (output <span class=\"op\">==</span> hidden).<span class=\"bu\">all</span>()</span>\n<span id=\"cb21-35\"><a href=\"#cb21-35\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-36\"><a href=\"#cb21-36\" aria-hidden=\"true\" tabindex=\"-1\"></a>        embedded <span class=\"op\">=</span> embedded.squeeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-37\"><a href=\"#cb21-37\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output <span class=\"op\">=</span> output.squeeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-38\"><a href=\"#cb21-38\" aria-hidden=\"true\" tabindex=\"-1\"></a>        weighted <span class=\"op\">=</span> weighted.squeeze(<span class=\"dv\">0</span>)</span>\n<span id=\"cb21-39\"><a href=\"#cb21-39\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-40\"><a href=\"#cb21-40\" aria-hidden=\"true\" tabindex=\"-1\"></a>        prediction <span class=\"op\">=</span> <span class=\"va\">self</span>.fc_out(torch.cat((output,weighted,embedded), dim<span class=\"op\">=</span><span class=\"dv\">1</span>))</span>\n<span id=\"cb21-41\"><a href=\"#cb21-41\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb21-42\"><a href=\"#cb21-42\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> prediction,hidden.squeeze(<span class=\"dv\">0</span>),a.squeeze(<span class=\"dv\">1</span>)</span></code></pre></div>\n<h4 id=\"seq2seq\">seq2seq</h4>\n<ul>\n<li>构建一个seq2seq类将encoder、decoder和attention整合起来，参数：\n<ul>\n<li>encoder：encoder类</li>\n<li>decoder：decoder类</li>\n<li>doc_pad_idx：原文词典中pad符号的序号</li>\n<li>device：需要传入的设备</li>\n</ul></li>\n<li>create_mask的参数：\n<ul>\n<li>doc：原文数据，create_mask会根据原文中pad符号的位置构建mask矩阵，这个mask矩阵会传入decoder，可以在计算attention时规避到pad符号的影响</li>\n</ul></li>\n<li>forward的参数：\n<ul>\n<li>doc：传入的一个批次的原文数据，是已经由词转换成序号的数据</li>\n<li>doc_len：一个批次里每个数据的长度，用来生成mask矩阵</li>\n<li>sum：摘要数据，同样已被转换成序号</li>\n<li>teacher_forcing_ratio：teacher_forcing的概率，teacher_forcing是文本生成技术常用的技术，在训练时，如果一个词生成有误差，可能会影响到后面所有的词，所以以一定的概率选择生成的词还是标注的训练数据中相应位置的词，在验证测试时，不会用到teacher_forcing</li>\n</ul></li>\n</ul>\n<div class=\"sourceCode\" id=\"cb22\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb22-1\"><a href=\"#cb22-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">class</span> Seq2Seq(nn.Module):</span>\n<span id=\"cb22-2\"><a href=\"#cb22-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> <span class=\"fu\">__init__</span>(<span class=\"va\">self</span>,encoder,decoder,doc_pad_idx,device):</span>\n<span id=\"cb22-3\"><a href=\"#cb22-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">super</span>().<span class=\"fu\">__init__</span>()</span>\n<span id=\"cb22-4\"><a href=\"#cb22-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-5\"><a href=\"#cb22-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.encoder <span class=\"op\">=</span> encoder</span>\n<span id=\"cb22-6\"><a href=\"#cb22-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.decoder <span class=\"op\">=</span> decoder</span>\n<span id=\"cb22-7\"><a href=\"#cb22-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.doc_pad_idx <span class=\"op\">=</span> doc_pad_idx</span>\n<span id=\"cb22-8\"><a href=\"#cb22-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"va\">self</span>.device <span class=\"op\">=</span> device</span>\n<span id=\"cb22-9\"><a href=\"#cb22-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-10\"><a href=\"#cb22-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> create_mask(<span class=\"va\">self</span>,doc):</span>\n<span id=\"cb22-11\"><a href=\"#cb22-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>        mask <span class=\"op\">=</span> (doc <span class=\"op\">!=</span> <span class=\"va\">self</span>.doc_pad_idx).permute(<span class=\"dv\">1</span>,<span class=\"dv\">0</span>)</span>\n<span id=\"cb22-12\"><a href=\"#cb22-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> mask</span>\n<span id=\"cb22-13\"><a href=\"#cb22-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb22-14\"><a href=\"#cb22-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"kw\">def</span> forward(<span class=\"va\">self</span>,doc,doc_len,<span class=\"bu\">sum</span>, teacher_forcing_ratio<span class=\"op\">=</span><span class=\"fl\">0.5</span>):</span>\n<span id=\"cb22-15\"><a href=\"#cb22-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        batch_size <span class=\"op\">=</span> doc.shape[<span class=\"dv\">1</span>]</span>\n<span id=\"cb22-16\"><a href=\"#cb22-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-17\"><a href=\"#cb22-17\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(type(sum))</span></span>\n<span id=\"cb22-18\"><a href=\"#cb22-18\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(sum)</span></span>\n<span id=\"cb22-19\"><a href=\"#cb22-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_len <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>].shape[<span class=\"dv\">0</span>]</span>\n<span id=\"cb22-20\"><a href=\"#cb22-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_vocab_size<span class=\"op\">=</span> <span class=\"va\">self</span>.decoder.output_dim</span>\n<span id=\"cb22-21\"><a href=\"#cb22-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-22\"><a href=\"#cb22-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 定义一个tensor来存储每一个生成的单词序号</span></span>\n<span id=\"cb22-23\"><a href=\"#cb22-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        outputs <span class=\"op\">=</span> torch.zeros(sum_len,batch_size,sum_vocab_size).to(<span class=\"va\">self</span>.device)</span>\n<span id=\"cb22-24\"><a href=\"#cb22-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-25\"><a href=\"#cb22-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># encoder_outputs 是 encoder所有的输出状态</span></span>\n<span id=\"cb22-26\"><a href=\"#cb22-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># hidder是 encoder整体的输出</span></span>\n<span id=\"cb22-27\"><a href=\"#cb22-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs , hidden <span class=\"op\">=</span> <span class=\"va\">self</span>.encoder(doc,doc_len)</span>\n<span id=\"cb22-28\"><a href=\"#cb22-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-29\"><a href=\"#cb22-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 输入的第一个字符为&lt;sos&gt;</span></span>\n<span id=\"cb22-30\"><a href=\"#cb22-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">input</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>][<span class=\"dv\">0</span>,:]</span>\n<span id=\"cb22-31\"><a href=\"#cb22-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-32\"><a href=\"#cb22-32\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 构建一个mask矩阵， 包含训练数据原文中 pad符号的位置</span></span>\n<span id=\"cb22-33\"><a href=\"#cb22-33\" aria-hidden=\"true\" tabindex=\"-1\"></a>        mask <span class=\"op\">=</span> <span class=\"va\">self</span>.create_mask(doc)</span>\n<span id=\"cb22-34\"><a href=\"#cb22-34\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb22-35\"><a href=\"#cb22-35\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">for</span> t <span class=\"kw\">in</span> <span class=\"bu\">range</span>(<span class=\"dv\">1</span>, sum_len):</span>\n<span id=\"cb22-36\"><a href=\"#cb22-36\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">try</span>:</span>\n<span id=\"cb22-37\"><a href=\"#cb22-37\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># decoder 输入 前一步生成的单词embedding, 前一步状态hidden, encoder所有状态以及mask矩阵</span></span>\n<span id=\"cb22-38\"><a href=\"#cb22-38\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 返回预测全连接层的输出和这一步的状态</span></span>\n<span id=\"cb22-39\"><a href=\"#cb22-39\" aria-hidden=\"true\" tabindex=\"-1\"></a>                output,hidden,_ <span class=\"op\">=</span> <span class=\"va\">self</span>.decoder(<span class=\"bu\">input</span>,hidden,encoder_outputs,mask)</span>\n<span id=\"cb22-40\"><a href=\"#cb22-40\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-41\"><a href=\"#cb22-41\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 把output的信息存储在之前定义的 outputs里</span></span>\n<span id=\"cb22-42\"><a href=\"#cb22-42\" aria-hidden=\"true\" tabindex=\"-1\"></a>                outputs[t] <span class=\"op\">=</span> output</span>\n<span id=\"cb22-43\"><a href=\"#cb22-43\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-44\"><a href=\"#cb22-44\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 生成一个随机数， 来决定是否使用 teacher forcing</span></span>\n<span id=\"cb22-45\"><a href=\"#cb22-45\" aria-hidden=\"true\" tabindex=\"-1\"></a>                teacher_force <span class=\"op\">=</span> random.random() <span class=\"op\">&lt;</span> teacher_forcing_ratio</span>\n<span id=\"cb22-46\"><a href=\"#cb22-46\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-47\"><a href=\"#cb22-47\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 获得可能性最高的单词序号 作为生成的单词</span></span>\n<span id=\"cb22-48\"><a href=\"#cb22-48\" aria-hidden=\"true\" tabindex=\"-1\"></a>                top1 <span class=\"op\">=</span> output.argmax(<span class=\"dv\">1</span>)</span>\n<span id=\"cb22-49\"><a href=\"#cb22-49\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb22-50\"><a href=\"#cb22-50\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 如果使用teacher forcing则用训练数据相应位置的单词</span></span>\n<span id=\"cb22-51\"><a href=\"#cb22-51\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"co\"># 否则使用生成的单词 作为下一步的输入单词</span></span>\n<span id=\"cb22-52\"><a href=\"#cb22-52\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"bu\">input</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[t] <span class=\"cf\">if</span> teacher_force <span class=\"cf\">else</span> top1</span>\n<span id=\"cb22-53\"><a href=\"#cb22-53\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">except</span> <span class=\"pp\">Exception</span> <span class=\"im\">as</span> e:</span>\n<span id=\"cb22-54\"><a href=\"#cb22-54\" aria-hidden=\"true\" tabindex=\"-1\"></a>                <span class=\"cf\">pass</span></span>\n<span id=\"cb22-55\"><a href=\"#cb22-55\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">return</span> outputs      </span></code></pre></div>\n<h3 id=\"模型实例化\">模型实例化</h3>\n<p>利用定义好的模型结构实例化encoder和decoder。</p>\n<div class=\"sourceCode\" id=\"cb23\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb23-1\"><a href=\"#cb23-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>INPUT_DIM <span class=\"op\">=</span> <span class=\"bu\">len</span>(DOCUMENT.vocab)</span>\n<span id=\"cb23-2\"><a href=\"#cb23-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>OUTPUT_DIM <span class=\"op\">=</span> <span class=\"bu\">len</span>(SUMMARY.vocab)</span>\n<span id=\"cb23-3\"><a href=\"#cb23-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>ENC_EMB_DIM <span class=\"op\">=</span> <span class=\"dv\">256</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-4\"><a href=\"#cb23-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>DEC_EMB_DIM <span class=\"op\">=</span> <span class=\"dv\">256</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-5\"><a href=\"#cb23-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>ENC_HID_DIM <span class=\"op\">=</span> <span class=\"dv\">512</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-6\"><a href=\"#cb23-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>DEC_HID_DIM <span class=\"op\">=</span> <span class=\"dv\">512</span><span class=\"op\">//</span><span class=\"dv\">64</span></span>\n<span id=\"cb23-7\"><a href=\"#cb23-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>ENC_DROPOUT <span class=\"op\">=</span> <span class=\"fl\">0.5</span></span>\n<span id=\"cb23-8\"><a href=\"#cb23-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>DEC_DROPOUT <span class=\"op\">=</span> <span class=\"fl\">0.5</span></span>\n<span id=\"cb23-9\"><a href=\"#cb23-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>DOC_PAD_IDX <span class=\"op\">=</span> DOCUMENT.vocab.stoi[DOCUMENT.pad_token]</span>\n<span id=\"cb23-10\"><a href=\"#cb23-10\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb23-11\"><a href=\"#cb23-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>attn <span class=\"op\">=</span> Attention(ENC_HID_DIM,DEC_HID_DIM)</span>\n<span id=\"cb23-12\"><a href=\"#cb23-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>enc <span class=\"op\">=</span> Encoder(INPUT_DIM,ENC_EMB_DIM,ENC_HID_DIM,DEC_HID_DIM,ENC_DROPOUT)</span>\n<span id=\"cb23-13\"><a href=\"#cb23-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>dec <span class=\"op\">=</span> Decoder(OUTPUT_DIM,DEC_EMB_DIM,ENC_HID_DIM,DEC_HID_DIM,DEC_DROPOUT,attn)</span>\n<span id=\"cb23-14\"><a href=\"#cb23-14\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb23-15\"><a href=\"#cb23-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>model <span class=\"op\">=</span> Seq2Seq(enc,dec,DOC_PAD_IDX,device).to(device)</span></code></pre></div>\n<h4 id=\"查看模型\">查看模型</h4>\n<div class=\"sourceCode\" id=\"cb24\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb24-1\"><a href=\"#cb24-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>model</span></code></pre></div>\n<pre><code>Seq2Seq(\n  (encoder): Encoder(\n    (embedding): Embedding(16555, 4)\n    (rnn): GRU(4, 8, bidirectional=True)\n    (fc): Linear(in_features=16, out_features=8, bias=True)\n    (dropout): Dropout(p=0.5, inplace=False)\n  )\n  (decoder): Decoder(\n    (attention): Attention(\n      (attn): Linear(in_features=24, out_features=8, bias=True)\n      (v): Linear(in_features=8, out_features=1, bias=False)\n    )\n    (embedding): Embedding(9267, 4)\n    (rnn): GRU(20, 8)\n    (fc_out): Linear(in_features=28, out_features=9267, bias=True)\n    (dropout): Dropout(p=0.5, inplace=False)\n  )\n)</code></pre>\n<h3 id=\"模型训练\">模型训练</h3>\n<ul>\n<li>使用之前处理的训练数据对模型训练，主要包括\n<ul>\n<li>定义训练函数</li>\n<li>定义验证函数</li>\n<li>定义时间显示函数</li>\n<li>训练过程</li>\n<li>模型保存</li>\n</ul></li>\n</ul>\n<h4 id=\"定义训练函数\">定义训练函数</h4>\n<p>定义训练一个 epoch的函数，并返回损失，参数 - model: 用以训练的模型 -\niteration: 用以训练的数据迭代器 - optimizer: 训练模型使用的优化器 -\ncriterion: 训练模型使用的损失函数 - clip: 梯度截断的值，\n传入torch.nn.utils.clip_grad_norm_中，如果梯度超过这个clip，会使用clip对梯度进行截断，可以预防训练初期的梯度爆炸现象。</p>\n<h4 id=\"定义验证函数\">定义验证函数</h4>\n<p>返回测试/验证数据的损失， 参数： - model: 用以验证的模型 - iteration:\n用以验证/测试的数据迭代器 - criterion: 验证/测试模型的损失函数</p>\n<div class=\"sourceCode\" id=\"cb26\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb26-1\"><a href=\"#cb26-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> train(model,iterator,optimizer,criterion,clip):</span>\n<span id=\"cb26-2\"><a href=\"#cb26-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    model.train()</span>\n<span id=\"cb26-3\"><a href=\"#cb26-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb26-4\"><a href=\"#cb26-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    epoch_loss <span class=\"op\">=</span> <span class=\"dv\">0</span></span>\n<span id=\"cb26-5\"><a href=\"#cb26-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb26-6\"><a href=\"#cb26-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">for</span> i,batch <span class=\"kw\">in</span> <span class=\"bu\">enumerate</span>(iterator):</span>\n<span id=\"cb26-7\"><a href=\"#cb26-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>        doc,doc_len <span class=\"op\">=</span> batch.document</span>\n<span id=\"cb26-8\"><a href=\"#cb26-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">sum</span> <span class=\"op\">=</span> batch.summary</span>\n<span id=\"cb26-9\"><a href=\"#cb26-9\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(&quot;****************这是train************************&quot;)</span></span>\n<span id=\"cb26-10\"><a href=\"#cb26-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(type(sum))</span></span>\n<span id=\"cb26-11\"><a href=\"#cb26-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#         print(sum)</span></span>\n<span id=\"cb26-12\"><a href=\"#cb26-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>        optimizer.zero_grad()</span>\n<span id=\"cb26-13\"><a href=\"#cb26-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-14\"><a href=\"#cb26-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output <span class=\"op\">=</span> model(doc,doc_len,<span class=\"bu\">sum</span>)</span>\n<span id=\"cb26-15\"><a href=\"#cb26-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-16\"><a href=\"#cb26-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output_dim <span class=\"op\">=</span> output.shape[<span class=\"op\">-</span><span class=\"dv\">1</span>]</span>\n<span id=\"cb26-17\"><a href=\"#cb26-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-18\"><a href=\"#cb26-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>        output <span class=\"op\">=</span> output[<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>,output_dim)</span>\n<span id=\"cb26-19\"><a href=\"#cb26-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"bu\">sum</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>][<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>)</span>\n<span id=\"cb26-20\"><a href=\"#cb26-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-21\"><a href=\"#cb26-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>        loss <span class=\"op\">=</span> criterion(output,<span class=\"bu\">sum</span>)</span>\n<span id=\"cb26-22\"><a href=\"#cb26-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-23\"><a href=\"#cb26-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        loss.backward()</span>\n<span id=\"cb26-24\"><a href=\"#cb26-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-25\"><a href=\"#cb26-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>        torch.nn.utils.clip_grad_norm_(model.parameters(),clip)</span>\n<span id=\"cb26-26\"><a href=\"#cb26-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-27\"><a href=\"#cb26-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>        optimizer.step()</span>\n<span id=\"cb26-28\"><a href=\"#cb26-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb26-29\"><a href=\"#cb26-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>        epoch_loss <span class=\"op\">+=</span> loss.item()</span>\n<span id=\"cb26-30\"><a href=\"#cb26-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">if</span> i<span class=\"op\">&gt;</span><span class=\"dv\">20</span>:<span class=\"cf\">break</span></span>\n<span id=\"cb26-31\"><a href=\"#cb26-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> epoch_loss <span class=\"op\">/</span> <span class=\"bu\">len</span>(iterator)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb27\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb27-1\"><a href=\"#cb27-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> evaluate(model,iterator,criterion):</span>\n<span id=\"cb27-2\"><a href=\"#cb27-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    model.<span class=\"bu\">eval</span>()</span>\n<span id=\"cb27-3\"><a href=\"#cb27-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb27-4\"><a href=\"#cb27-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    epoch_loss <span class=\"op\">=</span> <span class=\"dv\">0</span></span>\n<span id=\"cb27-5\"><a href=\"#cb27-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">with</span> torch.no_grad():</span>\n<span id=\"cb27-6\"><a href=\"#cb27-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">for</span> i,batch <span class=\"kw\">in</span> <span class=\"bu\">enumerate</span>(iterator):</span>\n<span id=\"cb27-7\"><a href=\"#cb27-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>            doc,doc_len <span class=\"op\">=</span> batch.document</span>\n<span id=\"cb27-8\"><a href=\"#cb27-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"bu\">sum</span> <span class=\"op\">=</span> batch.summary</span>\n<span id=\"cb27-9\"><a href=\"#cb27-9\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#             print(&quot;****************这是evaluate************************&quot;)</span></span>\n<span id=\"cb27-10\"><a href=\"#cb27-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#             print(type(sum))</span></span>\n<span id=\"cb27-11\"><a href=\"#cb27-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\">#             print(sum)</span></span>\n<span id=\"cb27-12\"><a href=\"#cb27-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output <span class=\"op\">=</span> model(doc,doc_len,<span class=\"bu\">sum</span>,<span class=\"dv\">0</span>)</span>\n<span id=\"cb27-13\"><a href=\"#cb27-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-14\"><a href=\"#cb27-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output_dim <span class=\"op\">=</span> output.shape[<span class=\"op\">-</span><span class=\"dv\">1</span>]</span>\n<span id=\"cb27-15\"><a href=\"#cb27-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-16\"><a href=\"#cb27-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output <span class=\"op\">=</span> output[<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>,output_dim)</span>\n<span id=\"cb27-17\"><a href=\"#cb27-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"bu\">sum</span> <span class=\"op\">=</span> <span class=\"bu\">sum</span>[<span class=\"dv\">0</span>][<span class=\"dv\">1</span>:].view(<span class=\"op\">-</span><span class=\"dv\">1</span>)</span>\n<span id=\"cb27-18\"><a href=\"#cb27-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-19\"><a href=\"#cb27-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>            loss <span class=\"op\">=</span> criterion(output,<span class=\"bu\">sum</span>)</span>\n<span id=\"cb27-20\"><a href=\"#cb27-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb27-21\"><a href=\"#cb27-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>            epoch_loss <span class=\"op\">+=</span> loss.item()</span>\n<span id=\"cb27-22\"><a href=\"#cb27-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">if</span> i<span class=\"op\">&gt;</span><span class=\"dv\">20</span>:<span class=\"cf\">break</span></span>\n<span id=\"cb27-23\"><a href=\"#cb27-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> epoch_loss <span class=\"op\">/</span> <span class=\"bu\">len</span>(iterator)</span></code></pre></div>\n<h4 id=\"定义时间显示的函数\">定义时间显示的函数</h4>\n<div class=\"sourceCode\" id=\"cb28\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb28-1\"><a href=\"#cb28-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> epoch_time(start_time,end_time):</span>\n<span id=\"cb28-2\"><a href=\"#cb28-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    elapsed_time <span class=\"op\">=</span> end_time <span class=\"op\">-</span>start_time</span>\n<span id=\"cb28-3\"><a href=\"#cb28-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    elapsed_mins <span class=\"op\">=</span> <span class=\"bu\">int</span>(elapsed_time <span class=\"op\">/</span> <span class=\"dv\">60</span>)</span>\n<span id=\"cb28-4\"><a href=\"#cb28-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    elapsed_secs <span class=\"op\">=</span> <span class=\"bu\">int</span>(elapsed_time <span class=\"op\">-</span>(elapsed_mins <span class=\"op\">*</span> <span class=\"dv\">60</span>))</span>\n<span id=\"cb28-5\"><a href=\"#cb28-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> elapsed_mins,elapsed_secs</span></code></pre></div>\n<h4 id=\"训练过程\">训练过程</h4>\n<p>对整体的数据训练，分多个批次训练。 -\n训练过程中，每个epoch后输出耗时、训练损失和验证损失。 -\n这里只训练了5个epoch，训练使用adam学习器，的学习率lr设置为0.001，weight\ndecay设置为0.0001，CLIP设置为1。 -\n训练使用CrossEntropyLoss交叉熵损失，代表生成摘要每个位置单词和训练数据中相应位置的差异，如果训练数据中某个位置为pad符号，则计算损失时不计算生成摘要该位置的单词的损失。</p>\n<div class=\"sourceCode\" id=\"cb29\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb29-1\"><a href=\"#cb29-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>N_EPOCHS <span class=\"op\">=</span> <span class=\"dv\">1</span></span>\n<span id=\"cb29-2\"><a href=\"#cb29-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>CLIP <span class=\"op\">=</span> <span class=\"dv\">1</span></span>\n<span id=\"cb29-3\"><a href=\"#cb29-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>lr<span class=\"op\">=</span> <span class=\"fl\">0.001</span></span>\n<span id=\"cb29-4\"><a href=\"#cb29-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>weight_decay <span class=\"op\">=</span> <span class=\"fl\">0.0001</span></span>\n<span id=\"cb29-5\"><a href=\"#cb29-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>SUM_PAD_IDX <span class=\"op\">=</span> SUMMARY.vocab.stoi[SUMMARY.pad_token]</span>\n<span id=\"cb29-6\"><a href=\"#cb29-6\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb29-7\"><a href=\"#cb29-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>criterion <span class=\"op\">=</span> nn.CrossEntropyLoss(ignore_index<span class=\"op\">=</span>SUM_PAD_IDX)</span>\n<span id=\"cb29-8\"><a href=\"#cb29-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>optimizer <span class=\"op\">=</span> optim.Adam(model.parameters(),lr<span class=\"op\">=</span>lr,weight_decay<span class=\"op\">=</span>weight_decay)</span>\n<span id=\"cb29-9\"><a href=\"#cb29-9\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb29-10\"><a href=\"#cb29-10\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 训练</span></span>\n<span id=\"cb29-11\"><a href=\"#cb29-11\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">for</span> epoch <span class=\"kw\">in</span> <span class=\"bu\">range</span>(N_EPOCHS):</span>\n<span id=\"cb29-12\"><a href=\"#cb29-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>    start_time <span class=\"op\">=</span> time.time()</span>\n<span id=\"cb29-13\"><a href=\"#cb29-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-14\"><a href=\"#cb29-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>    train_loss <span class=\"op\">=</span> train(model,train_iter, optimizer, criterion,CLIP)</span>\n<span id=\"cb29-15\"><a href=\"#cb29-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>    valid_loss <span class=\"op\">=</span> evaluate(model,val_iter,criterion)</span>\n<span id=\"cb29-16\"><a href=\"#cb29-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-17\"><a href=\"#cb29-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>    end_time <span class=\"op\">=</span> time.time()</span>\n<span id=\"cb29-18\"><a href=\"#cb29-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-19\"><a href=\"#cb29-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>    epoch_mins,epoch_secs <span class=\"op\">=</span> epoch_time(start_time,end_time)</span>\n<span id=\"cb29-20\"><a href=\"#cb29-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb29-21\"><a href=\"#cb29-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"ss\">f&#39;Epoch: </span><span class=\"sc\">&#123;</span>epoch <span class=\"op\">+</span> <span class=\"dv\">1</span><span class=\"sc\">:02&#125;</span><span class=\"ss\"> | Time:</span><span class=\"sc\">&#123;</span>epoch_mins<span class=\"sc\">&#125;</span><span class=\"ss\">m </span><span class=\"sc\">&#123;</span>epoch_secs<span class=\"sc\">&#125;</span><span class=\"ss\">s&#39;</span>)</span>\n<span id=\"cb29-22\"><a href=\"#cb29-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"ss\">f&#39;</span><span class=\"ch\">\\t</span><span class=\"ss\">Train Loss: </span><span class=\"sc\">&#123;</span>train_loss <span class=\"sc\">:.3f&#125;</span><span class=\"ss\"> | Tain PPL:</span><span class=\"sc\">&#123;</span>math<span class=\"sc\">.</span>exp(train_loss)<span class=\"sc\">:7.3f&#125;</span><span class=\"ss\">&#39;</span>)</span>\n<span id=\"cb29-23\"><a href=\"#cb29-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"ss\">f&#39;</span><span class=\"ch\">\\t</span><span class=\"ss\"> Val. Loss: </span><span class=\"sc\">&#123;</span>valid_loss<span class=\"sc\">:.3f&#125;</span><span class=\"ss\"> |  Val. PPL: </span><span class=\"sc\">&#123;</span>math<span class=\"sc\">.</span>exp(valid_loss)<span class=\"sc\">:7.3f&#125;</span><span class=\"ss\">&#39;</span>)</span></code></pre></div>\n<pre><code>Epoch: 01 | Time:0m 1s\n    Train Loss: 0.050 | Tain PPL:  1.052\n     Val. Loss: 0.999 |  Val. PPL:   2.716</code></pre>\n<h4 id=\"模型保存\">模型保存</h4>\n<div class=\"sourceCode\" id=\"cb31\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb31-1\"><a href=\"#cb31-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>torch.save(model.state_dict(),<span class=\"st\">&#39;model.pt&#39;</span>)</span></code></pre></div>\n<h3 id=\"模型预测\">模型预测</h3>\n<ul>\n<li>模型加载</li>\n<li>构建预测函数</li>\n<li>读取数据</li>\n<li>预测</li>\n</ul>\n<h4 id=\"模型加载\">模型加载</h4>\n<div class=\"sourceCode\" id=\"cb32\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb32-1\"><a href=\"#cb32-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>model.load_state_dict(torch.load(<span class=\"st\">&#39;model.pt&#39;</span>))</span></code></pre></div>\n<pre><code>&lt;All keys matched successfully&gt;</code></pre>\n<h4 id=\"构建预测函数\">构建预测函数</h4>\n<p>构建生成的函数，输入原文的字符串，输出生成摘要的字符串，参数为： -\ndoc_sentence:摘要的字符串 -\ndoc_field:之前定义的针对document的预处理格式DOCUMENT -\nsum_field:之前定义的针对summary的预处理格式SUMMARY -\nmodel:训练的seq2seq模型 - device:数据存放的设备 -\nmax_len:生成摘要的最长长度</p>\n<div class=\"sourceCode\" id=\"cb34\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb34-1\"><a href=\"#cb34-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"kw\">def</span> generate_summary(doc_sentence,doc_field,sum_field,model,device,max_len<span class=\"op\">=</span><span class=\"dv\">50</span>):</span>\n<span id=\"cb34-2\"><a href=\"#cb34-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 将模型部署为验证模式</span></span>\n<span id=\"cb34-3\"><a href=\"#cb34-3\" aria-hidden=\"true\" tabindex=\"-1\"></a>    model.<span class=\"bu\">eval</span>()</span>\n<span id=\"cb34-4\"><a href=\"#cb34-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-5\"><a href=\"#cb34-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 对原文分词</span></span>\n<span id=\"cb34-6\"><a href=\"#cb34-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    nlp <span class=\"op\">=</span> spacy.load(<span class=\"st\">&#39;en_core_web_sm&#39;</span>)</span>\n<span id=\"cb34-7\"><a href=\"#cb34-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-8\"><a href=\"#cb34-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>    tokens <span class=\"op\">=</span> [token.text.lower() <span class=\"cf\">for</span> token <span class=\"kw\">in</span> nlp(doc_sentence)]</span>\n<span id=\"cb34-9\"><a href=\"#cb34-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-10\"><a href=\"#cb34-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 为原文加上起始符号&lt;sos&gt; 和结束符号&lt;eos&gt;</span></span>\n<span id=\"cb34-11\"><a href=\"#cb34-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>    tokens <span class=\"op\">=</span> [doc_field.init_token] <span class=\"op\">+</span> tokens <span class=\"op\">+</span> [doc_field.eos_token]</span>\n<span id=\"cb34-12\"><a href=\"#cb34-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-13\"><a href=\"#cb34-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 将字符转换为序号</span></span>\n<span id=\"cb34-14\"><a href=\"#cb34-14\" aria-hidden=\"true\" tabindex=\"-1\"></a>    doc_indexes <span class=\"op\">=</span> [doc_field.vocab.stoi[token] <span class=\"cf\">for</span> token <span class=\"kw\">in</span> tokens]</span>\n<span id=\"cb34-15\"><a href=\"#cb34-15\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-16\"><a href=\"#cb34-16\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 转换成可以gpu计算的tensor</span></span>\n<span id=\"cb34-17\"><a href=\"#cb34-17\" aria-hidden=\"true\" tabindex=\"-1\"></a>    doc_tensor <span class=\"op\">=</span> torch.LongTensor(doc_indexes).unsqueeze(<span class=\"dv\">1</span>).to(device)</span>\n<span id=\"cb34-18\"><a href=\"#cb34-18\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-19\"><a href=\"#cb34-19\" aria-hidden=\"true\" tabindex=\"-1\"></a>    doc_len <span class=\"op\">=</span> torch.LongTensor([<span class=\"bu\">len</span>(doc_indexes)]).to(device)</span>\n<span id=\"cb34-20\"><a href=\"#cb34-20\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-21\"><a href=\"#cb34-21\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 计算encoder</span></span>\n<span id=\"cb34-22\"><a href=\"#cb34-22\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">with</span> torch.no_grad():</span>\n<span id=\"cb34-23\"><a href=\"#cb34-23\" aria-hidden=\"true\" tabindex=\"-1\"></a>        encoder_outputs,hidden <span class=\"op\">=</span> model.encoder(doc_tensor,doc_len)</span>\n<span id=\"cb34-24\"><a href=\"#cb34-24\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-25\"><a href=\"#cb34-25\" aria-hidden=\"true\" tabindex=\"-1\"></a>    mask <span class=\"op\">=</span> model.create_mask(doc_tensor)</span>\n<span id=\"cb34-26\"><a href=\"#cb34-26\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-27\"><a href=\"#cb34-27\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 生成摘要的一个单词&lt;sos&gt;</span></span>\n<span id=\"cb34-28\"><a href=\"#cb34-28\" aria-hidden=\"true\" tabindex=\"-1\"></a>    sum_indexes <span class=\"op\">=</span> [sum_field.vocab.stoi[sum_field.init_token]]</span>\n<span id=\"cb34-29\"><a href=\"#cb34-29\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-30\"><a href=\"#cb34-30\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 构建一个attention tensor，存储每一步的attention</span></span>\n<span id=\"cb34-31\"><a href=\"#cb34-31\" aria-hidden=\"true\" tabindex=\"-1\"></a>    attentions <span class=\"op\">=</span> torch.zeros(max_len,<span class=\"dv\">1</span>,<span class=\"bu\">len</span>(doc_indexes)).to(device)</span>\n<span id=\"cb34-32\"><a href=\"#cb34-32\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-33\"><a href=\"#cb34-33\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">for</span> i <span class=\"kw\">in</span> <span class=\"bu\">range</span>(max_len):</span>\n<span id=\"cb34-34\"><a href=\"#cb34-34\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_tensor <span class=\"op\">=</span> torch.LongTensor([sum_indexes[<span class=\"op\">-</span><span class=\"dv\">1</span>]]).to(device)</span>\n<span id=\"cb34-35\"><a href=\"#cb34-35\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-36\"><a href=\"#cb34-36\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 计算每一步的decoder</span></span>\n<span id=\"cb34-37\"><a href=\"#cb34-37\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">with</span> torch.no_grad():</span>\n<span id=\"cb34-38\"><a href=\"#cb34-38\" aria-hidden=\"true\" tabindex=\"-1\"></a>            output,hidden,attention <span class=\"op\">=</span> model.decoder(sum_tensor, hidden, encoder_outputs,mask)</span>\n<span id=\"cb34-39\"><a href=\"#cb34-39\" aria-hidden=\"true\" tabindex=\"-1\"></a>            </span>\n<span id=\"cb34-40\"><a href=\"#cb34-40\" aria-hidden=\"true\" tabindex=\"-1\"></a>        attentions[i] <span class=\"op\">=</span> attention</span>\n<span id=\"cb34-41\"><a href=\"#cb34-41\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-42\"><a href=\"#cb34-42\" aria-hidden=\"true\" tabindex=\"-1\"></a>        pred_token <span class=\"op\">=</span> output.argmax(<span class=\"dv\">1</span>).item()</span>\n<span id=\"cb34-43\"><a href=\"#cb34-43\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-44\"><a href=\"#cb34-44\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"co\"># 如果出现了 &lt;eos&gt; 则直接结束计算</span></span>\n<span id=\"cb34-45\"><a href=\"#cb34-45\" aria-hidden=\"true\" tabindex=\"-1\"></a>        <span class=\"cf\">if</span> pred_token <span class=\"op\">==</span> sum_field.vocab.stoi[sum_field.eos_token]:</span>\n<span id=\"cb34-46\"><a href=\"#cb34-46\" aria-hidden=\"true\" tabindex=\"-1\"></a>            <span class=\"cf\">break</span></span>\n<span id=\"cb34-47\"><a href=\"#cb34-47\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-48\"><a href=\"#cb34-48\" aria-hidden=\"true\" tabindex=\"-1\"></a>        sum_indexes.append(pred_token)</span>\n<span id=\"cb34-49\"><a href=\"#cb34-49\" aria-hidden=\"true\" tabindex=\"-1\"></a>        </span>\n<span id=\"cb34-50\"><a href=\"#cb34-50\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"co\"># 把序号转换成单词</span></span>\n<span id=\"cb34-51\"><a href=\"#cb34-51\" aria-hidden=\"true\" tabindex=\"-1\"></a>    sum_tokens <span class=\"op\">=</span> [sum_field.vocab.itos[i] <span class=\"cf\">for</span> i <span class=\"kw\">in</span> sum_indexes]</span>\n<span id=\"cb34-52\"><a href=\"#cb34-52\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb34-53\"><a href=\"#cb34-53\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"cf\">return</span> sum_tokens[<span class=\"dv\">1</span>:], attentions[:<span class=\"bu\">len</span>(sum_tokens)<span class=\"op\">-</span><span class=\"dv\">1</span>]</span></code></pre></div>\n<h4 id=\"读取数据\">读取数据</h4>\n<div class=\"sourceCode\" id=\"cb35\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb35-1\"><a href=\"#cb35-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_test <span class=\"op\">=</span> pd.read_csv(<span class=\"st\">&quot;dataset/test.csv&quot;</span>,encoding<span class=\"op\">=</span><span class=\"st\">&#39;utf-8&#39;</span>)</span>\n<span id=\"cb35-2\"><a href=\"#cb35-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>data_test <span class=\"op\">=</span> data_test[:<span class=\"dv\">100</span>]</span>\n<span id=\"cb35-3\"><a href=\"#cb35-3\" aria-hidden=\"true\" tabindex=\"-1\"></a></span>\n<span id=\"cb35-4\"><a href=\"#cb35-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>doc_sentence_list <span class=\"op\">=</span> data_test[<span class=\"st\">&#39;document&#39;</span>].tolist()</span>\n<span id=\"cb35-5\"><a href=\"#cb35-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>sum_sentence_list <span class=\"op\">=</span> data_test[<span class=\"st\">&#39;summary&#39;</span>].tolist()</span></code></pre></div>\n<h4 id=\"预测\">预测</h4>\n<div class=\"sourceCode\" id=\"cb36\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb36-1\"><a href=\"#cb36-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 使用generate_summary函数对测试集中所有的document生成摘要, 预测时，不能使用批次的方式预测，所有数据顺序预测，需要一定的时间。</span></span>\n<span id=\"cb36-2\"><a href=\"#cb36-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>generated_summary <span class=\"op\">=</span> []</span>\n<span id=\"cb36-3\"><a href=\"#cb36-3\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">for</span> doc_sentence <span class=\"kw\">in</span> doc_sentence_list:</span>\n<span id=\"cb36-4\"><a href=\"#cb36-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    summary_words,attention <span class=\"op\">=</span> generate_summary(doc_sentence,DOCUMENT,SUMMARY,model,device,max_len<span class=\"op\">=</span><span class=\"dv\">50</span>)</span>\n<span id=\"cb36-5\"><a href=\"#cb36-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    summary_sentence <span class=\"op\">=</span> (<span class=\"st\">&#39; &#39;</span>).join(summary_words)</span>\n<span id=\"cb36-6\"><a href=\"#cb36-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    generated_summary.append(summary_sentence)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb37\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb37-1\"><a href=\"#cb37-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 输出一个生成的摘要</span></span>\n<span id=\"cb37-2\"><a href=\"#cb37-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>indices <span class=\"op\">=</span> random.sample(<span class=\"bu\">range</span>(<span class=\"dv\">0</span>,<span class=\"bu\">len</span>(sum_sentence_list)),<span class=\"dv\">5</span>)</span>\n<span id=\"cb37-3\"><a href=\"#cb37-3\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"cf\">for</span> index <span class=\"kw\">in</span> indices:</span>\n<span id=\"cb37-4\"><a href=\"#cb37-4\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;******document******&quot;</span>)</span>\n<span id=\"cb37-5\"><a href=\"#cb37-5\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(doc_sentence_list[index])</span>\n<span id=\"cb37-6\"><a href=\"#cb37-6\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb37-7\"><a href=\"#cb37-7\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;******generated summary:*******&quot;</span>)</span>\n<span id=\"cb37-8\"><a href=\"#cb37-8\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(generated_summary[index])</span>\n<span id=\"cb37-9\"><a href=\"#cb37-9\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb37-10\"><a href=\"#cb37-10\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;*******reference summary:*******&quot;</span>)</span>\n<span id=\"cb37-11\"><a href=\"#cb37-11\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(sum_sentence_list[index])</span>\n<span id=\"cb37-12\"><a href=\"#cb37-12\" aria-hidden=\"true\" tabindex=\"-1\"></a>    </span>\n<span id=\"cb37-13\"><a href=\"#cb37-13\" aria-hidden=\"true\" tabindex=\"-1\"></a>    <span class=\"bu\">print</span>(<span class=\"st\">&quot;***************************&quot;</span>)</span></code></pre></div>\n<pre><code>******document******\nsouth african mining giant anglo american said on tuesday that it had agreed to sell the &lt;unk&gt; &lt;unk&gt; group for ### million dollars -lrb- ### million euros -rrb- in cash to private equity group advent international .\n******generated summary:*******\ncommunity pilgrims organizers qualifiers nt thailand descends number village village village village vie profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile replacement profile\n*******reference summary:*******\nanglo american sells &lt;unk&gt; &lt;unk&gt; for ### mln dlrs\n***************************\n******document******\nthe patriots locked up super bowl hero adam vinatieri friday , removing the `` franchise player &#39;&#39; tag and signing him to a three-year deal , and now they will wait to see if there is any interest in a drew bledsoe deal at the owners &#39; meetings in orlando this upcoming week .\n******generated summary:*******\ndescends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open\n*******reference summary:*******\npats sign vinatieri to #-year deal\n***************************\n******document******\ngreg oden was on a path to follow lebron james , a high school prodigy leaping directly to the national basketball association , but he now must wait until #### to seek professional riches .\n******generated summary:*******\ndescends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open\n*******reference summary:*******\nnba hot prospect oden now looks to college first\n***************************\n******document******\npedro astacio did n&#39;t allow a hit until geoff jenkins lined a single to left field with one out in the seventh inning saturday , and the new york mets beat the milwaukee brewers #-# .\n******generated summary:*******\ndescends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open descends open\n*******reference summary:*******\nastacio nearly no-hits brewers as mets win #-#\n***************************\n******document******\nfighting spread saturday through the alleys of densely populated west bank refugee camps , where palestinian militants reportedly were handing out explosives-packed belts to residents willing to strap them on and challenge israeli soldiers .\n******generated summary:*******\nreplacement republican performance thailand descends thailand descends number village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village village\n*******reference summary:*******\nfighting spreads through palestinian refugee camps as death toll\n***************************</code></pre>\n<h3 id=\"模型评估\">模型评估</h3>\n<ul>\n<li>模型加载</li>\n<li>损失评估</li>\n<li>指标评估</li>\n</ul>\n<h4 id=\"模型加载-1\">模型加载</h4>\n<div class=\"sourceCode\" id=\"cb39\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb39-1\"><a href=\"#cb39-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>model.load_state_dict(torch.load(<span class=\"st\">&#39;model.pt&#39;</span>))</span></code></pre></div>\n<pre><code>&lt;All keys matched successfully&gt;</code></pre>\n<h4 id=\"损失评估\">损失评估</h4>\n<div class=\"sourceCode\" id=\"cb41\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb41-1\"><a href=\"#cb41-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"co\"># 评估测试集的损失，输出损失。直接调用之前定义的evaluate函数，输入为测试数据的迭代器。</span></span>\n<span id=\"cb41-2\"><a href=\"#cb41-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>test_loss<span class=\"op\">=</span> evaluate(model,test_iter,criterion)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb42\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb42-1\"><a href=\"#cb42-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"bu\">print</span>(<span class=\"ss\">f&#39;| Test Loss:</span><span class=\"sc\">&#123;</span>test_loss<span class=\"sc\">:.3f&#125;</span><span class=\"ss\"> | Test PPL:</span><span class=\"sc\">&#123;</span>math<span class=\"sc\">.</span>exp(test_loss)<span class=\"sc\">:7.3f&#125;</span><span class=\"ss\"> |&#39;</span>)</span></code></pre></div>\n<pre><code>| Test Loss:0.998 | Test PPL:  2.713 |</code></pre>\n<h4 id=\"指标评估\">指标评估</h4>\n<p>文本自动摘要的指标通常为ROUGE（Recall-Oriented Understudy for Gisting\nEvaluation），在2004年由Chin-Yew Lin提出。 <img src=\"/.top//attachment:e4ae16be-a267-4f86-9401-d4284cb6223d.png\" alt=\"image.png\"></p>\n<ul>\n<li>分母是人工摘要（也就是数据中标注的摘要）中n-gram的个数，分子是人工摘要和机器生成的自动摘要共现（重合）的n-gram的个数。</li>\n<li>可以看出，ROUGE与召回率（recall）的定义很相似。分母也可以是机器生成的摘要，这样就是准确率（precision），同时也可以计算F1指数。</li>\n<li>通常情况下只用召回率，展示1-gram和2-gram的结果ROUGE-1和ROUGE-2。</li>\n<li>除了ROUGE-1和ROUGE-2之外，还可以用人工摘要和机器生成的摘要的最长公共子序列(Longest\nCommon\nSequence)的长度和生成摘要或者标注摘要的长度之间的比例来评估摘要模型</li>\n</ul>\n<figure>\n<img src=\"/.top//attachment:a96e27f2-6e52-47cf-bc06-9b18468f2e27.png\" alt=\"image.png\">\n<figcaption aria-hidden=\"true\">image.png</figcaption>\n</figure>\n<ul>\n<li>第一个公式分母为标注的摘要长度，计算召回率。第二个公式分母为生成的摘要长度，计算准确率。第三个公式求\n<span class=\"math inline\">\\(F_\\beta\\)</span> ， <span class=\"math inline\">\\(\\beta\\)</span> 的值通常大于1。\n和ROUGE-1、ROUGE-2不同的是，ROUGE-L主要关注F指数。</li>\n<li>目前用python计算评估ROUGE指标通常使用pyrouge，但是pyrouge的安装需要预先安装ROUGE工具，较为麻烦，我们这里直接使用rouge工具包进行ROUGE的评估，rouge可以直接使用pip\ninstall\nrouge安装。rouge输入生成的摘要和人工摘要，输出ROUGE-1、ROUGE-2、ROUGE-L的f指数、准确率和召回率。</li>\n</ul>\n<div class=\"sourceCode\" id=\"cb44\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb44-1\"><a href=\"#cb44-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"im\">from</span> rouge <span class=\"im\">import</span> Rouge</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb45\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb45-1\"><a href=\"#cb45-1\" aria-hidden=\"true\" tabindex=\"-1\"></a>rouge <span class=\"op\">=</span> Rouge()</span>\n<span id=\"cb45-2\"><a href=\"#cb45-2\" aria-hidden=\"true\" tabindex=\"-1\"></a>scores <span class=\"op\">=</span> rouge.get_scores(generated_summary,sum_sentence_list,avg<span class=\"op\">=</span><span class=\"va\">True</span>)</span></code></pre></div>\n<div class=\"sourceCode\" id=\"cb46\"><pre class=\"sourceCode python\"><code class=\"sourceCode python\"><span id=\"cb46-1\"><a href=\"#cb46-1\" aria-hidden=\"true\" tabindex=\"-1\"></a><span class=\"bu\">print</span>(scores)</span></code></pre></div>\n<pre><code>&#123;&#39;rouge-1&#39;: &#123;&#39;f&#39;: 0.0003508771714373667, &#39;p&#39;: 0.0002, &#39;r&#39;: 0.0014285714285714286&#125;, &#39;rouge-2&#39;: &#123;&#39;f&#39;: 0.0, &#39;p&#39;: 0.0, &#39;r&#39;: 0.0&#125;, &#39;rouge-l&#39;: &#123;&#39;f&#39;: 0.0024999999625000004, &#39;p&#39;: 0.005, &#39;r&#39;: 0.0016666666666666666&#125;&#125;</code></pre>\n<h4 id=\"存在如下问题\">存在如下问题</h4>\n<p>目前普遍使用seq2seq解决文本摘要问题，会出现以下问题：</p>\n<p>1.OOV问题</p>\n<p>源文档语料中的词的数量级通常会很大,但是经常使用的词数量则相对比较固定。因此通常会根据词的频率过滤掉一些词做成词表。这样的做法会导致生成摘要时会遇到UNK的词。</p>\n<p>2.摘要的可读性。</p>\n<p>通常使用贪心算法或者beamsearch方法来做decoding。这些方法生成的句子有时候会存在不通顺的问题。</p>\n<p>3.摘要的重复性。</p>\n<p>这个问题出现的频次很高。与2的原因类似，由于一些decoding的方法的自身缺陷，导致模型会在某一段连续timesteps生成重复的词。</p>\n<p>4.长文本摘要生成难度大。</p>\n<p>对于机器翻译来说，NLG的输入和输出的语素长度大致都在一个量级上，因此NLG在其之上的效果较好。但是对摘要来说，源文本的长度与目标文本的长度通常相差很大，此时就需要encoder很好的将文档的信息总结归纳并传递给decoder，decoder需要完全理解并生成句子。可想而知，这是一个很难的事情。</p>\n<p>5.模型的训练目标与最终的评测指标不太一致。</p>\n<p>这里牵扯到两个问题，一个是seq2seq的训练模式中，通常会使用teacher-forcing的方式，即在decoder上，将真实target的输入和模型在前一时刻生成的词一起送到下一个时刻的神经元中计算。但是在inference时，是不会有真实target的，因此存在一个gap；另一个问题就是通常模型训练的目标函数都是交叉熵损失函数。但是摘要的评测却不是以交叉熵来判断的，目前一些榜单通常以ROUGE、BLEU等方式评测，虽然这些评测也不是很完美，但是与交叉熵的评测角度均在较大差异。</p>\n<p>优化思路 可以尝试如何利用深度无监督模型去做生成式摘要任务。</p>\n<p>例如：以自编码器为主体架构，对其进行不同程度的改造，从压缩或者生成两个角度去无监督生成摘要文本，\n同时为了提升效果，也会利用GPT,XLNET等预训练语言模型做finetune。</p>\n<hr>\n<h3 id=\"about-me\">About ME</h3>\n<h5 id=\"读书城南-在未来面前我们都是孩子\">👋 读书城南，🤔\n在未来面前，我们都是孩子～</h5>\n<ul>\n<li>📙\n一个热衷于探索学习新方向、新事物的智能产品经理，闲暇时间喜欢coding💻、画图🎨、音乐🎵、学习ing~</li>\n</ul>\n<h5 id=\"social-media\">👋 Social Media</h5>\n<ul>\n<li><p>🛠️ Blog: <a href=\"http://oceaneyes.top\">http://oceaneyes.top</a></p></li>\n<li><p>⚡ PM导航: <a href=\"https://pmhub.oceangzy.top\">https://pmhub.oceangzy.top</a></p></li>\n<li><p>☘️ CNBLOG: <a href=\"https://www.cnblogs.com/oceaneyes-gzy/\">https://www.cnblogs.com/oceaneyes-gzy/</a></p></li>\n<li><p>🌱 AI PRJ自己部署的一些算法demo: <a href=\"http://ai.oceangzy.top/\">http://ai.oceangzy.top/</a></p></li>\n<li><p>📫 Email: 1450136519@qq.com</p></li>\n<li><p>💬 WeChat: <a href=\"https://oceaneyes.top/img/wechatqrcode.jpg\">OCEANGZY</a></p></li>\n<li><p>💬 公众号: <a href=\"https://oceaneyes.top/img/wechatgzh.jpeg\">UncleJoker-GZY</a></p></li>\n</ul>\n<h5 id=\"加入小组\">👋 加入小组~</h5>\n<p><img src=\"https://oceaneyes.top/img/zhishigroup.jpg\" title=\"加入组织\" alt width=\"240\"></p>\n<h5 id=\"感谢打赏\">👋 感谢打赏~</h5>\n<p><img src=\"https://oceaneyes.top/img/alipay.jpg\" title=\"支付宝打赏\" alt width=\"140\">\n<img src=\"https://oceaneyes.top/img/wechatpay.jpg\" title=\"微信打赏\" alt width=\"140\"></p>\n","categories":[{"name":"Artificial Intelligence","path":"api/categories/Artificial Intelligence.json"},{"name":"Machine Learning","path":"api/categories/Machine Learning.json"},{"name":"Algorithm","path":"api/categories/Algorithm.json"}],"tags":[{"name":"Machine Learning","path":"api/tags/Machine Learning.json"},{"name":"Algorithm","path":"api/tags/Algorithm.json"},{"name":"NLP","path":"api/tags/NLP.json"}]}